# 00_P2完全ガイド_資料一覧.md

**作成日**: 2026-01-03  
**対象フェーズ**: P2.0 (A+B) + P2.5 (CSP)  
**ステータス**: 統合完全版

---

## 📚 本資料セットの構成

本資料セットは、vNext Ledger の P2実装の完全ガイドです。P2.0 (A+B) とP2.5 (CSP) の両フェーズをカバーします。

### 資料構成（4ファイル）

| No | ファイル名 | 用途 | 対象読者 | ページ数 |
|----|-----------|------|---------|---------|
| 00 | 00_P2完全ガイド_資料一覧.md | 本ファイル（全体概要） | 全員 | - |
| 10 | 10_P2実装手順書_完全版.md | 段階的実装手順 | 実装担当者 | ~1500行 |
| 20 | 20_P2総合仕様書_設計思想.md | 設計判断と思想 | アーキテクト | ~800行 |
| 30 | 30_P2変更点メモ_運用ガイド.md | 差分と運用注意 | 運用担当者 | ~600行 |

---

## 📋 P2 プロジェクト概要

### P2 の2つのフェーズ

#### P2.0: A+B（UI tighten準備 + render集約）

**目的**:
1. **A（UI tighten準備）**: inline script/style を外部ファイル化
2. **B（render集約）**: HTML生成を `app.py` から `render.py` に追放

**主要成果物**:
- static/ui.js（外部JS化）
- render.py（HTML生成集約）
- 循環import回避（契約）

**実装方針**:
- "移動"が主目的（リファクタは後回し）
- 既存のAPI/レスポンス意味を変えない
- テスト全通必須（pytest）

---

#### P2.5: CSP（Content Security Policy）

**目的**: XSS攻撃防止のセキュリティ強化

**主要成果物**:
- app.py への CSP実装（約484行追加）
- テストスイート拡充（51本）
- 段階的移行（off → report → enforce）

**実装方針**:
- 監査台帳（P0/P1）に一切触らない
- 境界マーカーで保護
- 契約駆動テスト

---

### 実装統計

#### P2.0 (A+B)

| 項目 | 数値 | 備考 |
|------|------|------|
| 新規ファイル | 2個 | ui.js, render.py |
| 変更ファイル | 2個 | index.htmx, app.py |
| 削除対象 | inline全排除 | `<script>`, onclick=, hx-on: |
| テスト数 | 18本 | 全green必須 |

#### P2.5 (CSP)

| 項目 | 数値 | 備考 |
|------|------|------|
| 追加行数 | 約484行 | app.py への追加実装 |
| テスト数 | 51本 | 全green（CI確認済み） |
| 主要関数 | 7個 | CSP関連関数 |
| エンドポイント | 1個 | /__csp_report |
| 環境変数 | 4個 | CSP_MODE等 |
| 段階的移行 | 3段階 | off / report / enforce |

---

## 🎯 読者別ガイド

### ケース1: 初めてP2を実装する方

**推奨順序**:
1. 本ファイル（00_資料一覧）で全体像把握 ← いまここ
2. 20_総合仕様書 で設計思想理解
3. 10_実装手順書 で段階的実装
4. 30_変更点メモ で注意事項確認

**所要時間**: 約2時間（読解） + 実装時間

**実装時間の目安**:
- P2.0 (A+B): 2-3時間
- P2.5 (CSP): 1-2時間（コード追加のみ）
- 合計: 3-5時間

---

### ケース2: P2.0実装状況を確認したい方

**推奨順序**:
1. 10_実装手順書 の「Done Criteria」確認
2. 30_変更点メモ の差分確認

**チェックコマンド**:
```bash
# inline 排除確認
python - <<'PY'
import re, pathlib
s = pathlib.Path("static/index.htmx").read_text(encoding="utf-8")
m = re.findall(r'<script(?![^>]*\bsrc=)|onclick=|hx-on:', s, flags=re.I)
print(f"inline残存: {len(m)}")
PY

# render関数追放確認
grep -c 'def render_' app.py
# → 0 であること

# テスト
python -m pytest -q
```

**所要時間**: 約10分

---

### ケース3: P2.5実装状況を確認したい方

**推奨順序**:
1. 30_変更点メモ の「Phase 1: P2.5実装完了」確認
2. 10_実装手順書 の「Phase 1完了チェックリスト」確認

**チェックコマンド**:
```bash
# テスト
python -m pytest -q
# → 51 passed

# CI
powershell -ExecutionPolicy Bypass -File .\scripts\ci_smoke.ps1
# → [ci_smoke] PASS
```

**所要時間**: 約5分

---

### ケース4: UI改修を実施する方（P2.5 Phase 2）

**推奨順序**:
1. 10_実装手順書 の「Phase 2: UI改修」セクション
2. test_csp_static_compat.py の仕様確認
3. 30_変更点メモ の注意事項確認

**所要時間**: 約30分（実装前準備） + 30分〜1時間（実装）

---

### ケース5: 運用担当者（CSP運用）

**推奨順序**:
1. 30_変更点メモ の「運用上の注意」確認
2. 20_総合仕様書 の「運用ガイド」セクション

**監視項目**:
- CSP_MODE の設定値
- violation レポート（report mode時）
- サンプリング辞書サイズ

**所要時間**: 約15分

---

## ✅ P2 完了チェックリスト

### P2.0: A+B（✅ or ⏭️）

#### A: UI tighten準備
- [ ] inline `<script>` 排除完了（0件）
- [ ] `onclick=` 排除完了（0件）
- [ ] `hx-on:` 排除完了（0件）
- [ ] static/ui.js 作成完了
- [ ] CSRF注入動作確認
- [ ] filters/modal/result 動作確認

#### B: render集約
- [ ] render.py 作成完了
- [ ] `def render_*` を app.py から全追放（0件）
- [ ] `import app` が render.py に存在しない（0件）
- [ ] 循環import回避確認
- [ ] テスト全通（pytest）

---

### P2.5: CSP（Phase別）

#### Phase 1: 実装完了（✅ or ⏭️）
- [ ] app.py への実装完了（約484行）
- [ ] 任意刺しA完了（app.state優先参照）
- [ ] 任意刺しB完了（enforce後レポート方針）
- [ ] テスト51本全green
- [ ] CI/CD統合完了
- [ ] 境界マーカー設置

#### Phase 2: UI改修（⏭️ 将来実施）
- [ ] static/styles.css 作成
- [ ] index.htmx から `<style>` タグ削除
- [ ] `<link rel="stylesheet">` 追加
- [ ] test_csp_static_compat.py 追加（3本）
- [ ] テスト54本全green確認
- [ ] UI表示確認

#### Phase 3: CSP enforce移行（⏭️ Phase 2後）

**Phase 3.1: report 運用**
- [ ] CSP_MODE=report 設定
- [ ] 全機能動作確認
- [ ] violation 収束確認
- [ ] 1日〜数日の安定運用

**Phase 3.2: enforce 移行**
- [ ] CSP_MODE=enforce 設定
- [ ] 全機能動作確認
- [ ] DevTools エラーなし確認
- [ ] レポート機能OFF確認
- [ ] 1週間〜1ヶ月の本番運用

---

## 🚦 実装の流れ（全体像）

### 段階的実装

```
P0/P1 完了
  ↓
┌─────────────────────────────────────┐
│ P2.0: A+B                          │
│ ├─ A: UI tighten準備（2-3h）       │
│ │   └─ inline排除 → ui.js        │
│ └─ B: render集約（1h）             │
│     └─ app.py → render.py        │
└─────────────────────────────────────┘
  ↓ pytest全通確認
┌─────────────────────────────────────┐
│ P2.5: CSP                          │
│ ├─ Phase 1: 実装（1-2h）           │
│ │   └─ app.py に484行追加         │
│ ├─ Phase 2: UI改修（30m-1h）       │
│ │   └─ inline style外部化         │
│ └─ Phase 3: enforce移行（1w-1m）   │
│     └─ report → enforce          │
└─────────────────────────────────────┘
  ↓
P3 へ
```

### タイムライン（目安）

| フェーズ | 所要時間 | 前提条件 | 成果物 |
|---------|---------|---------|--------|
| P2.0 準備 | 30分 | P1完了 | 環境確認 |
| P2.0 A実装 | 2-3時間 | - | ui.js |
| P2.0 B実装 | 1時間 | A完了 | render.py |
| P2.0 検証 | 30分 | B完了 | pytest全通 |
| **P2.0 計** | **4-5時間** | - | - |
| P2.5 Phase 1 | 1-2時間 | P2.0完了 | CSP実装 |
| P2.5 Phase 2 | 30m-1h | Phase 1完了 | styles.css |
| P2.5 Phase 3.1 | 1-3日 | Phase 2完了 | report運用 |
| P2.5 Phase 3.2 | 1w-1m | Phase 3.1完了 | enforce運用 |
| **P2.5 計** | **2時間+運用期間** | - | - |
| **総計** | **6-7時間+運用期間** | - | - |

---

## 🔗 関連リソース

### 外部資料

**CSP仕様**:
- https://www.w3.org/TR/CSP3/
- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP

**Reporting API**:
- https://w3c.github.io/reporting/

**HTMX**:
- https://htmx.org/

### プロジェクト内資料

**実装ファイル**:
- app.py: メインアプリケーション
- render.py: HTML生成集約
- static/ui.js: 外部JS
- static/index.htmx: メインHTML
- tests/: テストスイート

**生成資料**:
- test_csp_static_compat.py: UI改修後に追加（保管中）

---

## 📝 用語集

| 用語 | 定義 |
|------|------|
| **P2.0 A+B** | UI tighten準備（A）とrender集約（B）の2つのタスク |
| **inline排除** | `<script>`, onclick=, hx-on: を外部ファイル化 |
| **render集約** | HTML生成をapp.pyからrender.pyに移動 |
| **循環import** | render.py が app を importすること（禁止） |
| **P2.5** | Content Security Policy (CSP) 実装フェーズ |
| **CSP_MODE** | off/report/enforce の3段階 |
| **report mode** | 違反を観測するモード（ログ出力） |
| **enforce mode** | 違反をブロックするモード（本番） |
| **任意刺しA** | app.state優先参照（パフォーマンス改善） |
| **任意刺しB** | enforce後レポート不要（運用コスト抑制） |
| **境界マーカー** | P0/P1 CORE領域の保護マーカー |
| **監査台帳** | P0/P1の変更禁止領域 |

---

## ⚠️ 重要な注意事項

### 禁止事項（絶対厳守）

#### P2.0での禁止
1. ❌ **ついでリファクタ**
   - 命名美化、設計刷新、MVC化、DB変更、ルーティング変更
   - P2は"移動"が目的、リファクタはP2.5以降

2. ❌ **循環import**
   - `render.py` が `app` を import すること
   - 解決策: 引数で必要な情報を渡す

3. ❌ **HTMLの意図しない変更**
   - タグ構造、文言、並び順の変更
   - CSS classの変更（機能に影響）

4. ❌ **CDN fallback の復活**
   - `document.write` の復活
   - P2で削除したものを戻さない

5. ❌ **htmx listener の配置換え**
   - `htmx:afterSwap` / `afterRequest` はtop-level固定
   - 移動すると動作しない

#### P2.5での禁止
1. ❌ **P0/P1 CORE領域の編集**
   - 境界マーカーで保護された領域
   - 監査台帳が壊れる

2. ❌ **UI改修前の enforce**
   - Phase 2完了前に `CSP_MODE=enforce` 設定
   - UIが真っ白になる

3. ❌ **一発本番**
   - off → enforce への直接移行
   - 必ず report で観測期間を設ける

---

### 順守事項（必須）

#### P2.0での必須
1. ✅ **テスト全通**
   - `python -m pytest -q` が全green
   - 落ちたら修正必須

2. ✅ **Done Criteria確認**
   - inline残存: 0件
   - render関数残存: 0件（app.py）
   - import app: 0件（render.py）

3. ✅ **手動動作確認**
   - scan → filters refresh
   - result が10秒で消える
   - modal 背景クリック
   - clear filters

#### P2.5での必須
1. ✅ **境界マーカー遵守**
   - P0/P1 CORE領域は絶対に触らない
   - CI check で検知

2. ✅ **段階的移行**
   - off → report → enforce の順序
   - 飛ばさない

3. ✅ **violation 収束確認**
   - report mode で1日〜数日運用
   - 意図しない violation がゼロ

---

## 📞 トラブルシューティング（簡易版）

### よくある問題

#### P2.0

**Q1: inline が残っている**
```bash
# 確認
python - <<'PY'
import re, pathlib
s = pathlib.Path("static/index.htmx").read_text(encoding="utf-8")
m = re.findall(r'<script(?![^>]*\bsrc=)|onclick=|hx-on:', s, flags=re.I)
print(f"残存: {len(m)}")
for x in m[:3]:  # 最初の3件表示
    print(f"  - {x}")
PY

# 対処: 10_実装手順書 のStep A-1, A-2を再確認
```

**Q2: 循環import エラー**
```python
# エラー例
ImportError: cannot import name 'get_settings' from partially initialized module 'app'

# 原因: render.py が app を import している
# 対処: 引数で必要な情報を渡す
# NG: from app import get_settings
# OK: def render_something(..., mode: str):
```

**Q3: テストが落ちる**
```bash
# 確認
python -m pytest -v

# 対処: エラーメッセージを確認
# - AttributeError → render関数の移動ミス
# - AssertionError → レスポンス形式の変更
```

#### P2.5

**Q4: inline style が検出される（Phase 2）**
```bash
# 確認
python -m pytest tests/test_csp_static_compat.py -v

# 対処: 10_実装手順書 のPhase 2を再確認
```

**Q5: enforce で UI が壊れる（Phase 3.2）**
```bash
# 緊急対処
CSP_MODE=off

# 再起動
uvicorn app:app --reload

# 原因調査
# DevTools Console でエラー確認
```

---

## 📊 品質指標

### P2.0 完了の判定基準

| 指標 | 目標値 | 確認方法 |
|------|--------|---------|
| inline `<script>` | 0件 | Done Criteria A |
| `onclick=` / `hx-on:` | 0件 | Done Criteria A |
| `def render_*` in app.py | 0件 | Done Criteria B |
| `import app` in render.py | 0件 | Done Criteria B |
| pytest | 全green | `python -m pytest -q` |

### P2.5 完了の判定基準

| 指標 | 目標値 | 確認方法 |
|------|--------|---------|
| 追加行数 | 約484行 | git diff |
| テスト数 | 51本全green | `python -m pytest -q` |
| CI | PASS | `scripts/ci_smoke.ps1` |
| inline style（Phase 2後） | 0件 | test_csp_static_compat.py |
| violation（report後） | 意図しないものゼロ | ログ確認 |

---

## 📈 次のステップ

### P2.0完了後
- ✅ pytest全通確認
- ✅ 手動動作確認
- ⏭️ P2.5 Phase 1 へ

### P2.5 Phase 1完了後
- ✅ テスト51本全green
- ✅ CI統合確認
- ⏭️ P2.5 Phase 2（UI改修）へ

### P2.5 Phase 2完了後
- ✅ test_csp_static_compat.py 全green
- ✅ UI表示確認
- ⏭️ P2.5 Phase 3.1（report運用）へ

### P2.5 Phase 3.2完了後
- ✅ 1週間〜1ヶ月の本番運用
- ✅ DevToolsエラーなし
- ⏭️ P3 へ

---

## 📝 更新履歴

| 日付 | バージョン | 変更内容 | 担当 |
|------|-----------|---------|------|
| 2026-01-03 | 1.0 | 初版作成（P2統合完全版） | Claude |

---

## 📞 問い合わせ先

**技術的質問**:
1. 本資料セットを精読
2. 20_総合仕様書 の「FAQ」セクション参照
3. 30_変更点メモ の「トラブルシューティング」参照

**実装に関する質問**:
- 10_実装手順書 の該当セクション確認

**運用に関する質問**:
- 30_変更点メモ の「運用上の注意」確認

---

**00_P2完全ガイド_資料一覧.md - 終わり**
