# 30_P2å¤‰æ›´ç‚¹ãƒ¡ãƒ¢_é‹ç”¨ã‚¬ã‚¤ãƒ‰.md

**ä½œæˆæ—¥**: 2026-01-03  
**å¯¾è±¡ãƒ•ã‚§ãƒ¼ã‚º**: P2.0 (A+B) + P2.5 (CSP)  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: çµ±åˆå®Œå…¨ç‰ˆãƒ»é‹ç”¨ä¸­

---

## ğŸ“‹ ç›®æ¬¡

1. [ç¾åœ¨ã®çŠ¶æ…‹](#ç¾åœ¨ã®çŠ¶æ…‹)
2. [P2.0å®Ÿè£…æ¸ˆã¿å†…å®¹](#p20å®Ÿè£…æ¸ˆã¿å†…å®¹)
3. [P2.5å®Ÿè£…æ¸ˆã¿å†…å®¹](#p25å®Ÿè£…æ¸ˆã¿å†…å®¹)
4. [å°†æ¥ã®ã‚¿ã‚¹ã‚¯](#å°†æ¥ã®ã‚¿ã‚¹ã‚¯)
5. [é‹ç”¨ä¸Šã®æ³¨æ„](#é‹ç”¨ä¸Šã®æ³¨æ„)
6. [å·®åˆ†è©³ç´°](#å·®åˆ†è©³ç´°)
7. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)
8. [ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ](#ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ)

---

## ç¾åœ¨ã®çŠ¶æ…‹

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆ2026-01-03æ™‚ç‚¹ï¼‰

**P2.0 (A+B)**: âœ… å®Œäº† ã¾ãŸã¯ â­ï¸ å®Ÿæ–½å¾…ã¡  
**P2.5 Phase 1**: âœ… å®Œäº† ã¾ãŸã¯ â­ï¸ å®Ÿæ–½å¾…ã¡  
**P2.5 Phase 2**: â­ï¸ å¾…æ©Ÿä¸­ï¼ˆP3ç§»è¡Œå‰ã«å®Ÿæ–½ï¼‰  
**P2.5 Phase 3**: â­ï¸ ä¿ç•™ï¼ˆPhase 2å®Œäº†å¾Œï¼‰

---

### P2.0é‹ç”¨çŠ¶æ…‹

**ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ**:
```
vnext-ledger/
â”œâ”€â”€ app.pyï¼ˆrender_* é–¢æ•°ã‚’å‰Šé™¤æ¸ˆã¿ï¼‰
â”œâ”€â”€ render.pyï¼ˆæ–°è¦ï¼šHTMLç”Ÿæˆé›†ç´„ï¼‰
â””â”€â”€ static/
    â”œâ”€â”€ index.htmxï¼ˆinlineæ’é™¤æ¸ˆã¿ï¼‰
    â”œâ”€â”€ ui.jsï¼ˆæ–°è¦ï¼šJSé›†ç´„ï¼‰
    â””â”€â”€ vendor/
        â””â”€â”€ htmx.min.js
```

**ç¢ºèªé …ç›®**:
- inline script: 0ä»¶ âœ…
- onclick / hx-on: 0ä»¶ âœ…
- render_ é–¢æ•°ï¼ˆapp.pyï¼‰: 0ä»¶ âœ…
- import appï¼ˆrender.pyï¼‰: 0ä»¶ âœ…
- ãƒ†ã‚¹ãƒˆ: å…¨green âœ…

---

### P2.5é‹ç”¨çŠ¶æ…‹

**ç’°å¢ƒå¤‰æ•°**ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰:
```bash
MODE=prod
CSP_MODE=report           # è¦³æ¸¬ãƒ¢ãƒ¼ãƒ‰ç¶™ç¶šä¸­
CSP_USE_REPORTING_API=1   # Reporting API æœ‰åŠ¹
CSP_REPORT_URI=/__csp_report
```

**ãƒ†ã‚¹ãƒˆçŠ¶æ³**:
```
pytest: 51æœ¬å…¨green âœ…
CI: PASS âœ…
```

**èª²é¡Œ**:
- static/index.htmx ã« inline style æ®‹å­˜ï¼ˆLine 12-441ï¼‰
- CSP enforce æ™‚ã« UI ãŒç ´æã™ã‚‹ï¼ˆå°†æ¥å¯¾å¿œï¼‰

---

## P2.0å®Ÿè£…æ¸ˆã¿å†…å®¹

### 1. static/ui.js ã®ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: `static/ui.js`

**å†…å®¹**:
- htmx listenersï¼ˆtop-levelé…ç½®ï¼‰
  - `htmx:afterSwap`: result ã®10ç§’è‡ªå‹•æ¶ˆå»
  - `htmx:afterRequest`: scanå¾Œã® filters refresh
- Helper functions
  - `closeModal()`: modal ã‚’é–‰ã˜ã‚‹
- DOMContentLoaded handlers
  - clearFilters ãƒœã‚¿ãƒ³
  - modal backdrop ã‚¯ãƒªãƒƒã‚¯

**é‡è¦ãƒã‚¤ãƒ³ãƒˆ**:
- htmx listeners ã¯ top-levelï¼ˆdocument.bodyç›´ä¸‹ï¼‰
- DOMContentLoaded å†…ã«å…¥ã‚Œã‚‹ã¨å‹•ä½œã—ãªã„

---

### 2. static/index.htmx ã®ä¿®æ­£

**å¤‰æ›´å†…å®¹**:
- inline script ã®å®Œå…¨å‰Šé™¤
- onclick / hx-on å±æ€§ã®å‰Šé™¤
- ui.js ã®èª­ã¿è¾¼ã¿è¿½åŠ 

**å‰Šé™¤ã—ãŸã‚‚ã®**:
- CDN fallback ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆdocument.writeï¼‰
- body æœ«å°¾ã® inline script
- onclick="clearFilters()"
- onclick="closeModal()"

**è¿½åŠ ã—ãŸã‚‚ã®**:
```html
<script src="/static/ui.js" defer></script>
```

**id å±æ€§ã®è¿½åŠ **:
```html
<button id="clearFilters">Clear filters</button>
<div id="modal">...</div>
```

---

### 3. render.py ã®ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: `render.py`ï¼ˆrepoRoot/app.py ã¨åŒéšå±¤ï¼‰

**ç§»æ¤ã—ãŸé–¢æ•°**:
- `render_notes_table(notes)`
- `render_note_detail(note)`
- `render_summary(data, allowed_statuses)`
- `render_metrics(data)`
- `render_scan_result(...)`
- `render_no_ui()`

**é‡è¦ãƒã‚¤ãƒ³ãƒˆ**:
- `render.py` ã¯ `app` ã‚’ import ã—ãªã„ï¼ˆå¾ªç’°å›é¿ï¼‰
- `render_summary` ã®ã¿ `allowed_statuses` å¼•æ•°è¿½åŠ 
- ä»–ã®é–¢æ•°ã¯æ—¢å­˜ã®ã‚·ã‚°ãƒãƒãƒ£ç¶­æŒ

---

### 4. app.py ã®ä¿®æ­£

**å¤‰æ›´å†…å®¹**:
- HTML Rendering ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å®Œå…¨å‰Šé™¤
- render.py ã‹ã‚‰ã® import è¿½åŠ 
- å‘¼ã³å‡ºã—ç®‡æ‰€ã®1:1ç½®æ›

**å‰Šé™¤ã—ãŸã‚‚ã®**:
```python
# app.py
def render_notes_table(notes):
    ...  # å…¨ã¦å‰Šé™¤
```

**è¿½åŠ ã—ãŸã‚‚ã®**:
```python
# app.py
from render import (
    render_notes_table,
    render_note_detail,
    render_summary,
    render_metrics,
    render_scan_result,
    render_no_ui,
)
```

**å‘¼ã³å‡ºã—å¤‰æ›´**:
```python
# render_summary ã®ã¿å¼•æ•°è¿½åŠ 
return HTMLResponse(
    render_summary(data, allowed_statuses=ALLOWED_STATUS)
)
```

---

## P2.5å®Ÿè£…æ¸ˆã¿å†…å®¹

### 1. app.py ã¸ã®å®Ÿè£…ï¼ˆç´„484è¡Œè¿½åŠ ï¼‰

#### è¿½åŠ é–¢æ•°ï¼ˆ7å€‹ï¼‰

| é–¢æ•°å | è¡Œç•ªå· | ç”¨é€” |
|-------|--------|------|
| `_build_csp_policy()` | 1127-1175 | CSPãƒãƒªã‚·ãƒ¼æ–‡å­—åˆ—ç”Ÿæˆ |
| `_apply_security_headers_to_response()` | 1241-1326 | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ä»˜ä¸ |
| `_handle_csp_report()` | 1328-1437 | CSPé•åãƒ¬ãƒãƒ¼ãƒˆå—ä¿¡ |
| `_get_external_origin()` | 1439-1481 | çµ¶å¯¾URLæ§‹ç¯‰ï¼ˆãƒ—ãƒ­ã‚­ã‚·å¯¾å¿œï¼‰ |
| `sanitize_proto()` | 1443-1448 | proto ã‚µãƒ‹ã‚¿ã‚¤ã‚º |
| `sanitize_host()` | 1450-1455 | host ã‚µãƒ‹ã‚¿ã‚¤ã‚º |
| `lifespan()` | 1183-1207 | èµ·å‹•æ™‚CSPãƒãƒªã‚·ãƒ¼æ§‹ç¯‰ |

---

#### ä¸»è¦æ©Ÿèƒ½

**1. CSPãƒãƒªã‚·ãƒ¼å‹•çš„ç”Ÿæˆ**:
- style-src 'self' / script-src 'self'
- 'unsafe-inline' ãªã—ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å„ªå…ˆï¼‰
- 'report-sample' ä»˜ä¸ï¼ˆé•åã‚µãƒ³ãƒ—ãƒ«å–å¾—ï¼‰

**2. Reporting APIå¯¾å¿œ**:
- report-uriï¼ˆæ—§å¼ã€åºƒãå¯¾å¿œï¼‰
- report-toï¼ˆæ–°å¼ã€CSP3ï¼‰
- Reporting-Endpoints ãƒ˜ãƒƒãƒ€ï¼ˆçµ¶å¯¾URLï¼‰

**3. ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°æ©Ÿèƒ½**:
- åŒä¸€ violation ã‚’60ç§’ã«1å›ã ã‘ãƒ­ã‚°å‡ºåŠ›
- è¾æ›¸ä¸Šé™1000ä»¶ã€è¶…éæ™‚50%å‰Šé™¤

**4. DoSè€æ€§**:
- ã‚µã‚¤ã‚ºä¸Šé™100KB
- Content-Typeãƒã‚§ãƒƒã‚¯
- ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°

**5. ä¾‹å¤–çµŒè·¯ä¿è¨¼**:
- middleware + exception handler ã§çµ±åˆ
- å…¨ã‚¨ãƒ©ãƒ¼çµŒè·¯ã§CSPãƒ˜ãƒƒãƒ€ä»˜ä¸

---

### 2. ä»»æ„åˆºã—A: app.state å„ªå…ˆå‚ç…§

**ç›®çš„**: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„

**å®Ÿè£…ç®‡æ‰€**:
- Line 1199-1205ï¼ˆlifespanï¼‰: app.state ã¸ã®åˆæœŸè¨­å®š
- Line 1249-1254ï¼ˆmiddlewareï¼‰: app.state ã‹ã‚‰ã®å–å¾—

**åŠ¹æœ**:
- æ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ `get_settings()` ã‚’å‘¼ã°ãªã„
- æ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ `_build_csp_policy()` ã‚’å‘¼ã°ãªã„

**Before**:
```python
def _apply_security_headers_to_response(response, request):
    settings = get_settings()  # æ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    csp_policy = _build_csp_policy(settings)  # æ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
```

**After**:
```python
# lifespanï¼ˆèµ·å‹•æ™‚1å›ã®ã¿ï¼‰
app.state.csp_policy = _build_csp_policy(settings)

# middlewareï¼ˆæ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
csp_policy = request.app.state.csp_policy  # å–å¾—ã®ã¿
```

---

### 3. ä»»æ„åˆºã—B: enforceå¾Œãƒ¬ãƒãƒ¼ãƒˆæ–¹é‡æ˜æ–‡åŒ–

**ç›®çš„**: é‹ç”¨ã‚³ã‚¹ãƒˆæŠ‘åˆ¶

**å®Ÿè£…ç®‡æ‰€**:
- Line 1139-1174ï¼ˆ_build_csp_policyï¼‰: report mode ã®æ¡ä»¶è¿½åŠ 
- Line 1270ï¼ˆmiddlewareï¼‰: report mode ã®æ¡ä»¶è¿½åŠ 

**æ–¹é‡**:
```
report mode:  report-uri âœ… / Reporting-Endpoints âœ…ï¼ˆè¦³æ¸¬ã®ãŸã‚ï¼‰
enforce mode: report-uri âŒ / Reporting-Endpoints âŒï¼ˆé‹ç”¨ã‚³ã‚¹ãƒˆæŠ‘åˆ¶ï¼‰

ç†ç”±: enforceå¾Œã¯é•åã‚’æ­¢ã‚ã‚‹ã ã‘ã§ã€ãƒ¬ãƒãƒ¼ãƒˆåé›†ã¯ä¸è¦
æ€æƒ³: ã€Œå‰²ã«åˆã‚ãªã„æ”»æ’ƒã¯ç„¡è¦–ã€
```

**Before**:
```python
if settings.csp_report_uri:
    directives.append(f"report-uri {settings.csp_report_uri}")
```

**After**:
```python
# report mode ã®ã¿
if settings.csp_report_uri and settings.csp_mode == "report":
    directives.append(f"report-uri {settings.csp_report_uri}")
```

---

### 4. ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆï¼ˆ51æœ¬ï¼‰

**å†…è¨³**:
- test_csp_headers.py: 27æœ¬ï¼ˆCSPå‹•ä½œï¼‰
- test_audit_integrity.py: 5æœ¬ï¼ˆç›£æŸ»æ•´åˆæ€§ï¼‰
- ãã®ä»–: 19æœ¬

**å…¨green**: âœ… CIç¢ºèªæ¸ˆã¿

---

### 5. CI/CDçµ±åˆ

**ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**:
- scripts/ci_smoke.ps1: çµ±åˆæ¸ˆã¿CIã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- scripts/ci_export.ps1: export ãƒ†ã‚¹ãƒˆ
- scripts/restore_smoke.ps1: ãƒªã‚¹ãƒˆã‚¢ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

**å®Ÿè¡Œçµæœ**ï¼ˆ2026-01-03ï¼‰:
```powershell
51 passed in 2.76s
[ci_smoke] PASS
```

---

### 6. å¢ƒç•Œãƒãƒ¼ã‚«ãƒ¼è¨­ç½®

**ç›®çš„**: P0/P1 COREé ˜åŸŸã®ä¿è­·

**å®Ÿè£…ç®‡æ‰€**: app.py

```python
# === P0/P1 CORE: DO NOT EDIT IN P2.5 ===
# ï¼ˆP0/P1é ˜åŸŸï¼‰
# === P2.5 ONLY BELOW ===
# ï¼ˆP2.5é ˜åŸŸï¼‰
def _build_csp_policy(settings) -> str:
    ...
# === P2.5 END ===
```

**ä¿è¨¼**:
- å¢ƒç•Œãƒãƒ¼ã‚«ãƒ¼ã§è¦–è¦šçš„ã«ä¿è­·
- CIãƒã‚§ãƒƒã‚¯ã§æ¤œçŸ¥ï¼ˆcheck_p25_boundary.pyï¼‰

---

## å°†æ¥ã®ã‚¿ã‚¹ã‚¯

### Phase 2: UIæ”¹ä¿®ï¼ˆP3ç§»è¡Œå‰ï¼‰

**æ‰€è¦æ™‚é–“**: ç´„30åˆ†ã€œ1æ™‚é–“

#### ã‚¿ã‚¹ã‚¯ä¸€è¦§

| No | ã‚¿ã‚¹ã‚¯ | ãƒ•ã‚¡ã‚¤ãƒ« | ä½œæ¥­å†…å®¹ |
|----|--------|---------|---------|
| 1 | CSSå¤–éƒ¨åŒ– | static/styles.css | æ–°è¦ä½œæˆï¼ˆindex.htmx ã‹ã‚‰ç§»å‹•ï¼‰ |
| 2 | HTMLä¿®æ­£ | static/index.htmx | `<style>` â†’ `<link>` ã«å¤‰æ›´ |
| 3 | ãƒ†ã‚¹ãƒˆè¿½åŠ  | tests/test_csp_static_compat.py | ä¿ç®¡ä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ  |
| 4 | ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ | - | 54æœ¬å…¨greenç¢ºèª |
| 5 | UIç¢ºèª | - | ãƒ–ãƒ©ã‚¦ã‚¶ã§è¡¨ç¤ºç¢ºèª |

---

#### ã‚¿ã‚¹ã‚¯1: static/styles.css ä½œæˆ

**ä½œæ¥­å†…å®¹**:
```bash
# index.htmx ã® Line 12-441 ã‚’ã‚³ãƒ”ãƒ¼
# <style> ã¨ </style> ã‚’é™¤å¤–
# static/styles.css ã«ä¿å­˜
```

**æ³¨æ„äº‹é …**:
- CSS ã®å†…å®¹ã¯å¤‰æ›´ã—ãªã„ï¼ˆãã®ã¾ã¾ç§»å‹•ï¼‰
- ã‚»ãƒ¬ã‚¯ã‚¿ã‚„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ç¶­æŒ

---

#### ã‚¿ã‚¹ã‚¯2: index.htmx ä¿®æ­£

**Before**ï¼ˆLine 10-13ï¼‰:
```html
<script src="/static/vendor/htmx.min.js"></script>
<script src="/static/ui.js" defer></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  /* ... ç´„430è¡Œ ... */
</style>
```

**After**:
```html
<script src="/static/vendor/htmx.min.js"></script>
<script src="/static/ui.js" defer></script>
<link rel="stylesheet" href="/static/styles.css">
```

---

#### ã‚¿ã‚¹ã‚¯3: test_csp_static_compat.py è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: `tests/test_csp_static_compat.py`

**ãƒ†ã‚¹ãƒˆå†…å®¹**ï¼ˆ3æœ¬ï¼‰:
1. `test_static_html_has_no_inline_style_or_script()`: inline style/script æ¤œå‡º
2. `test_ui_js_has_no_eval_or_function_constructor()`: eval() / Function() æ¤œå‡º
3. `test_csp_policy_matches_static_content_contract()`: CSPãƒãƒªã‚·ãƒ¼æ•´åˆæ€§ç¢ºèª

**è¿½åŠ æ–¹æ³•**:
```bash
# ä¿ç®¡ä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
cp /path/to/test_csp_static_compat.py tests/
```

**ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ**:
```bash
# æ–°è¦ãƒ†ã‚¹ãƒˆã®ã¿
python -m pytest tests/test_csp_static_compat.py -v
# æœŸå¾…çµæœ: 3 passed

# å…¨ãƒ†ã‚¹ãƒˆ
python -m pytest -q
# æœŸå¾…çµæœ: 54 passed (51 + 3)
```

---

### Phase 3: CSP enforceç§»è¡Œï¼ˆPhase 2å®Œäº†å¾Œï¼‰

**æ‰€è¦æ™‚é–“**: 1é€±é–“ã€œ1ãƒ¶æœˆï¼ˆé‹ç”¨æœŸé–“å«ã‚€ï¼‰

#### Phase 3.1: CSP_MODE=report é‹ç”¨

**æœŸé–“**: æœ€ä½1æ—¥ã€œæ•°æ—¥

**å®Ÿæ–½å†…å®¹**:
1. UIã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
2. æ„å›³çš„é•åãƒ†ã‚¹ãƒˆï¼ˆ`eval("1")`ï¼‰
3. ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ç¢ºèª
4. æ™®æ®µã®å°ç·šç¢ºèª
5. violation åæŸç¢ºèª

**å®Œäº†æ¡ä»¶**:
- âœ… å…¨æ©Ÿèƒ½æ­£å¸¸å‹•ä½œ
- âœ… æ„å›³ã—ãªã„ violation ãªã—
- âœ… æœ€ä½1æ—¥ã€œæ•°æ—¥ã®å®‰å®šé‹ç”¨

---

#### Phase 3.2: CSP_MODE=enforce ç§»è¡Œ

**ç’°å¢ƒå¤‰æ•°å¤‰æ›´**:
```bash
CSP_MODE=enforce  # ã“ã‚Œã ã‘å¤‰æ›´
```

**å®Œäº†ç¢ºèª**:
1. å…¨æ©Ÿèƒ½æ­£å¸¸å‹•ä½œ
2. DevTools ã«ã‚¨ãƒ©ãƒ¼ãªã—
3. UI/UX ã«å½±éŸ¿ãªã—
4. ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½OFFç¢ºèª

**æœ¬ç•ªé‹ç”¨æœŸé–“**: æœ€ä½1é€±é–“ã€œ1ãƒ¶æœˆ

---

## é‹ç”¨ä¸Šã®æ³¨æ„

### P2.0é–¢é€£

#### 1. CDN fallback ã®æ‰±ã„

**ç¾çŠ¶**: å‰Šé™¤æ¸ˆã¿

**ç†ç”±**:
- `document.write` ã¯ defer ã§å‹•ã‹ãªã„
- CSPæº–å‚™ã®ãŸã‚ä¸€æ™‚å‰Šé™¤

**å¯¾ç­–**:
- `/static/vendor/htmx.min.js` ã‚’å¿…é ˆã«ã™ã‚‹
- P2.5ã§å†æ¤œè¨

---

#### 2. htmx listener ã®é…ç½®

**é‡è¦**: top-levelé…ç½®å¿…é ˆ

**æ­£ã—ã„é…ç½®**:
```javascript
// ui.jsï¼ˆtop-levelï¼‰
document.body.addEventListener('htmx:afterSwap', function(evt){
  // ...
});
```

**é–“é•ã£ãŸé…ç½®**:
```javascript
// âŒ DOMContentLoaded å†…ã«å…¥ã‚Œã‚‹ã¨å‹•ã‹ãªã„
document.addEventListener('DOMContentLoaded', function(){
  document.body.addEventListener('htmx:afterSwap', ...);  // NG
});
```

**ç†ç”±**: htmx ã®ä»•æ§˜è¦ä»¶

---

#### 3. å¾ªç’°import ã®å›é¿

**ç¦æ­¢**:
```python
# render.py
import app  # âŒ çµ¶å¯¾ã«ãƒ€ãƒ¡
```

**æ­£ã—ã„æ–¹æ³•**:
```python
# render.py
# app ã¯ import ã—ãªã„

def render_summary(data, allowed_statuses):
    # å¼•æ•°ã§å—ã‘å–ã‚‹
```

**ç†ç”±**: å¾ªç’°import ã¯ ImportError ã®åŸå› 

---

### P2.5é–¢é€£

#### 4. P0/P1é ˜åŸŸã®ç·¨é›†ç¦æ­¢

**é‡è¦**: P0/P1 CORE é ˜åŸŸã¯çµ¶å¯¾ã«ç·¨é›†ä¸å¯

**å¢ƒç•Œãƒãƒ¼ã‚«ãƒ¼**:
```python
# === P0/P1 CORE: DO NOT EDIT IN P2.5 ===
# ï¼ˆP0/P1é ˜åŸŸï¼‰
# === P2.5 ONLY BELOW ===
# ï¼ˆP2.5é ˜åŸŸï¼‰
# === P2.5 END ===
```

**ä¿è¨¼**:
- å¢ƒç•Œãƒãƒ¼ã‚«ãƒ¼ã§è¦–è¦šçš„ã«ä¿è­·
- CIãƒã‚§ãƒƒã‚¯ã§æ¤œçŸ¥ï¼ˆcheck_p25_boundary.pyï¼‰

**é•åæ™‚ã®å½±éŸ¿**:
- ç›£æŸ»å°å¸³ãŒå£Šã‚Œã‚‹
- P2.5ã®å¥‘ç´„é•å
- CIã§å³åº§ã«æ¤œçŸ¥

---

#### 5. CSP_MODE ã®åˆ‡ã‚Šæ›¿ãˆé †åº

**æ­£ã—ã„é †åº**:
```
off â†’ report â†’ enforce
```

**é–“é•ã£ãŸé †åº**:
```
off â†’ enforce  âŒï¼ˆå±é™ºï¼‰
```

**ç†ç”±**:
- report ã§é•åã‚’è¦³æ¸¬ã—ã¦ã‹ã‚‰ enforce ã«ç§»è¡Œ
- ä¸€ç™ºæœ¬ç•ªã¯å±é™ºï¼ˆUIç ´æãƒªã‚¹ã‚¯ï¼‰

---

#### 6. UIæ”¹ä¿®å‰ã® enforce ç¦æ­¢

**ç¦æ­¢äº‹é …**:
- Phase 2ï¼ˆUIæ”¹ä¿®ï¼‰å®Œäº†å‰ã« `CSP_MODE=enforce` è¨­å®š

**ç†ç”±**:
- inline style ãŒæ®‹ã£ã¦ã„ã‚‹
- UI ãŒçœŸã£ç™½ã«ãªã‚‹

**å¯¾å‡¦**:
1. Phase 2ï¼ˆUIæ”¹ä¿®ï¼‰ã‚’å®Œäº†
2. test_csp_static_compat.py ãŒå…¨green
3. ãã®å¾Œ enforce ã¸ç§»è¡Œ

---

#### 7. ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¾æ›¸ã®ç›£è¦–

**ç›£è¦–é …ç›®**:
- ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¾æ›¸ã®ã‚µã‚¤ã‚º
- 1000ä»¶ã«åˆ°é”ã—ãŸå ´åˆã¯è‡ªå‹•å‰Šé™¤

**ãƒ­ã‚°ä¾‹**:
```
INFO: CSP report sampling map size: 523
```

**ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š**:
- ã‚µã‚¤ã‚ºãŒ900ä»¶ã‚’è¶…ãˆãŸå ´åˆ

---

#### 8. ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã®é‹ç”¨æ–¹é‡

**ç¾åœ¨ï¼ˆCSP_MODE=reportï¼‰**:
- âœ… report-uri æœ‰åŠ¹
- âœ… Reporting-Endpoints æœ‰åŠ¹
- âœ… ãƒ­ã‚°å‡ºåŠ›æœ‰åŠ¹

**å°†æ¥ï¼ˆCSP_MODE=enforceï¼‰**:
- âŒ report-uri ç„¡åŠ¹ï¼ˆä»»æ„åˆºã—Bï¼‰
- âŒ Reporting-Endpoints ç„¡åŠ¹ï¼ˆä»»æ„åˆºã—Bï¼‰
- âŒ ãƒ­ã‚°å‡ºåŠ›ãªã—

**ç†ç”±**:
- enforceå¾Œã¯é•åã‚’æ­¢ã‚ã‚‹ã ã‘
- ãƒ¬ãƒãƒ¼ãƒˆåé›†ã¯é‹ç”¨ã‚³ã‚¹ãƒˆé«˜
- ã€Œå‰²ã«åˆã‚ãªã„æ”»æ’ƒã¯ç„¡è¦–ã€

---

## å·®åˆ†è©³ç´°

### P2.0ã®ä¸»è¦å¤‰æ›´

#### static/ui.jsï¼ˆæ–°è¦ä½œæˆï¼‰

**è¿½åŠ å†…å®¹**:
- htmx listenersï¼ˆç´„20è¡Œï¼‰
- Helper functionsï¼ˆç´„10è¡Œï¼‰
- DOMContentLoaded handlersï¼ˆç´„30è¡Œï¼‰

**åˆè¨ˆ**: ç´„60è¡Œ

---

#### static/index.htmxï¼ˆå¤‰æ›´ï¼‰

**å‰Šé™¤å†…å®¹**:
- CDN fallback ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆç´„5è¡Œï¼‰
- body æœ«å°¾ã® inline scriptï¼ˆç´„15è¡Œï¼‰
- onclick å±æ€§ï¼ˆç´„5ç®‡æ‰€ï¼‰

**è¿½åŠ å†…å®¹**:
- `<script src="/static/ui.js" defer></script>`ï¼ˆ1è¡Œï¼‰
- id å±æ€§ï¼ˆç´„5ç®‡æ‰€ï¼‰

**å·®åˆ†**: ç´„-20è¡Œ

---

#### render.pyï¼ˆæ–°è¦ä½œæˆï¼‰

**è¿½åŠ å†…å®¹**:
- import æ–‡ï¼ˆç´„3è¡Œï¼‰
- render_notes_tableï¼ˆç´„50è¡Œï¼‰
- render_note_detailï¼ˆç´„40è¡Œï¼‰
- render_summaryï¼ˆç´„60è¡Œï¼‰
- render_metricsï¼ˆç´„30è¡Œï¼‰
- render_scan_resultï¼ˆç´„20è¡Œï¼‰
- render_no_uiï¼ˆç´„10è¡Œï¼‰

**åˆè¨ˆ**: ç´„210è¡Œ

---

#### app.pyï¼ˆå¤‰æ›´ï¼‰

**å‰Šé™¤å†…å®¹**:
- HTML Rendering ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç´„210è¡Œï¼‰

**è¿½åŠ å†…å®¹**:
- render.py ã‹ã‚‰ã® importï¼ˆç´„8è¡Œï¼‰

**å·®åˆ†**: ç´„-200è¡Œ

---

### P2.5ã®ä¸»è¦å¤‰æ›´

#### app.py ã¸ã®è¿½åŠ å®Ÿè£…

| è¡Œç•ªå· | å†…å®¹ | ç¨®åˆ¥ | è¡Œæ•° |
|--------|------|------|------|
| 1127-1175 | `_build_csp_policy()` | æ–°è¦ | ç´„49è¡Œ |
| 1183-1207 | `lifespan()` æ‹¡å¼µ | å¤‰æ›´ | ç´„25è¡Œ |
| 1241-1326 | `_apply_security_headers_to_response()` | æ–°è¦ | ç´„86è¡Œ |
| 1328-1437 | `_handle_csp_report()` | æ–°è¦ | ç´„110è¡Œ |
| 1439-1481 | `_get_external_origin()` | æ–°è¦ | ç´„43è¡Œ |
| å¢ƒç•Œãƒãƒ¼ã‚«ãƒ¼ | ã‚³ãƒ¡ãƒ³ãƒˆ | æ–°è¦ | ç´„10è¡Œ |

**åˆè¨ˆ**: ç´„484è¡Œ

---

#### ä»»æ„åˆºã—Aãƒ»B ã®å·®åˆ†

**ä»»æ„åˆºã—Aï¼ˆapp.state å„ªå…ˆå‚ç…§ï¼‰**:
```diff
# lifespan
+ app.state.csp_mode = settings.csp_mode
+ app.state.csp_policy = _build_csp_policy(settings)
+ app.state.mode = settings.mode
+ app.state.csp_use_reporting_api = settings.csp_use_reporting_api
+ app.state.csp_report_uri = settings.csp_report_uri

# middleware
- settings = get_settings()
- csp_policy = _build_csp_policy(settings)
+ csp_mode = request.app.state.csp_mode
+ csp_policy = request.app.state.csp_policy
```

**ä»»æ„åˆºã—Bï¼ˆenforceå¾Œãƒ¬ãƒãƒ¼ãƒˆä¸è¦ï¼‰**:
```diff
# _build_csp_policy
- if settings.csp_report_uri:
+ if settings.csp_report_uri and settings.csp_mode == "report":
      directives.append(f"report-uri {settings.csp_report_uri}")

# middleware
- if csp_use_reporting_api and csp_report_uri:
+ if csp_mode == "report" and csp_use_reporting_api and csp_report_uri:
      # Reporting-Endpoints / Report-To ã‚’ä»˜ä¸
```

---

#### ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´

**è¿½åŠ ãƒ•ã‚¡ã‚¤ãƒ«**:
- tests/test_csp_headers.py: 27æœ¬ï¼ˆç´„500è¡Œï¼‰
- tests/test_audit_integrity.py: 5æœ¬ï¼ˆç´„150è¡Œï¼‰

**å°†æ¥è¿½åŠ äºˆå®š**:
- tests/test_csp_static_compat.py: 3æœ¬ï¼ˆç´„200è¡Œï¼‰

---

#### ç’°å¢ƒå¤‰æ•°ã®è¿½åŠ 

| ç’°å¢ƒå¤‰æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | ç”¨é€” |
|---------|-----------|------|
| CSP_MODE | "off" | CSPãƒ¢ãƒ¼ãƒ‰ï¼ˆoff/report/enforceï¼‰ |
| CSP_REPORT_URI | "/__csp_report" | CSPé•åãƒ¬ãƒãƒ¼ãƒˆå—ä¿¡URL |
| CSP_USE_REPORTING_API | False | Reporting API æœ‰åŠ¹åŒ– |

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### P2.0é–¢é€£

#### å•é¡Œ1: ui.js ãŒèª­ã¿è¾¼ã¾ã‚Œãªã„

**ç—‡çŠ¶**: ãƒ–ãƒ©ã‚¦ã‚¶ã® Console ã§ã‚¨ãƒ©ãƒ¼

**ç¢ºèª**:
```bash
# ãƒ–ãƒ©ã‚¦ã‚¶ã® Network ã‚¿ãƒ–ã§ç¢ºèª
# http://127.0.0.1:8000/static/ui.js
# â†’ 200 OK ã«ãªã£ã¦ã‚‹ã‹
```

**å¯¾ç­–**:
```python
# app.py ã® StaticFiles è¨­å®šã‚’ç¢ºèª
app.mount("/static", StaticFiles(directory=STATIC_DIR), name="static")
```

---

#### å•é¡Œ2: htmx ãŒå‹•ã‹ãªã„

**ç—‡çŠ¶**: filters refresh ãŒå‹•ã‹ãªã„

**ç¢ºèª**:
```javascript
// ãƒ–ãƒ©ã‚¦ã‚¶ã® Console ã§ç¢ºèª
console.log(window.htmx);
// â†’ object ãŒè¿”ã£ã¦ãã‚‹ã‹
```

**å¯¾ç­–**:
- htmx.min.js ãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã‚‹ã‹ç¢ºèª
- script ã‚¿ã‚°ã®é †åºã‚’ç¢ºèªï¼ˆhtmx â†’ ui.js ã®é †ï¼‰

---

#### å•é¡Œ3: clearFilters ãŒå‹•ã‹ãªã„

**ç—‡çŠ¶**: ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚ä½•ã‚‚èµ·ã“ã‚‰ãªã„

**ç¢ºèª**:
```javascript
// ãƒ–ãƒ©ã‚¦ã‚¶ã® Console ã§ç¢ºèª
document.getElementById('clearFilters');
// â†’ button è¦ç´ ãŒè¿”ã£ã¦ãã‚‹ã‹
```

**å¯¾ç­–**:
- button ã« `id="clearFilters"` ãŒä»˜ã„ã¦ã‚‹ã‹ç¢ºèª
- DOMContentLoaded ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è¦ç´ ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª

---

#### å•é¡Œ4: å¾ªç’°import ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**:
```
ImportError: cannot import name 'get_settings' from partially initialized module 'app'
```

**åŸå› **: render.py ãŒ app ã‚’ import ã—ã¦ã„ã‚‹

**å¯¾ç­–**:
```python
# NG
from app import get_settings

# OK
def render_something(..., mode: str):
    # å¼•æ•°ã§å¿…è¦ãªæƒ…å ±ã‚’æ¸¡ã™
```

---

### P2.5é–¢é€£

#### å•é¡Œ5: ãƒ†ã‚¹ãƒˆãŒè½ã¡ã‚‹

**ç—‡çŠ¶**: pytest ã§ FAIL

**ç¢ºèª**:
```bash
python -m pytest -v
# â†’ ã©ã®ãƒ†ã‚¹ãƒˆãŒè½ã¡ã¦ã‚‹ã‹ç¢ºèª
```

**å¯¾ç­–**:
- ç’°å¢ƒå¤‰æ•°è¨­å®šç¢ºèª
- DBçŠ¶æ…‹ç¢ºèª
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª

---

#### å•é¡Œ6: inline style ãŒæ¤œå‡ºã•ã‚Œã‚‹ï¼ˆPhase 2ï¼‰

**ç—‡çŠ¶**: test_csp_static_compat.py ã§ FAIL

**ç¢ºèª**:
```bash
python -m pytest tests/test_csp_static_compat.py -v
```

**å¯¾ç­–**:
1. index.htmx ã® `<style>` ã‚¿ã‚°ã‚’ç¢ºèª
2. static/styles.css ã¸ã®ç§»è¡Œã‚’ç¢ºèª
3. `<link rel="stylesheet">` ã®è¿½åŠ ã‚’ç¢ºèª

---

#### å•é¡Œ7: enforce ã§ UI ãŒå£Šã‚Œã‚‹ï¼ˆPhase 3.2ï¼‰

**ç—‡çŠ¶**: UI ãŒçœŸã£ç™½ã¾ãŸã¯è¡¨ç¤ºå´©ã‚Œ

**åŸå› **: inline style/script ãŒæ®‹ã£ã¦ã„ã‚‹

**å¯¾ç­–**:
1. å³åº§ã« `CSP_MODE=off` ã«å¤‰æ›´
2. ã‚¢ãƒ—ãƒªå†èµ·å‹•
3. DevTools Console ã§ã‚¨ãƒ©ãƒ¼ç¢ºèª
4. Phase 2 ã«æˆ»ã£ã¦ä¿®æ­£

**ç·Šæ€¥å¯¾å‡¦**:
```bash
CSP_MODE=off
uvicorn app:app --reload
```

---

#### å•é¡Œ8: Reporting-Endpoints ãŒ http

**ç—‡çŠ¶**: ãƒ¬ãƒãƒ¼ãƒˆURLãŒhttpã«ãªã‚‹

**ç¢ºèª**:
```bash
# ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã§ç¢ºèª
grep "Reporting-Endpoints" <log_file>
```

**å¯¾ç­–**:
1. ãƒ—ãƒ­ã‚­ã‚·è¨­å®šç¢ºèª
2. `x-forwarded-proto: https` ãŒæ¸¡ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
3. _get_external_origin() ã®ãƒ­ã‚°ç¢ºèª

---

#### å•é¡Œ9: ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¾æ›¸ãŒå¢—ãˆç¶šã‘ã‚‹

**ç—‡çŠ¶**: ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒå¢—åŠ 

**ç¢ºèª**:
```bash
# ãƒ­ã‚°ã§ç¢ºèª
grep "sampling map size" <log_file>
```

**å¯¾ç­–**:
1. ãƒ­ã‚°ã§ violation ã®ç¨®é¡ã‚’ç¢ºèª
2. å…±é€šã®åŸå› ã‚’ç‰¹å®š
3. ä¿®æ­£ã—ã¦ã‹ã‚‰å†èµ·å‹•

**æƒ³å®šå‹•ä½œ**:
- ä¸Šé™1000ä»¶ã§è‡ªå‹•å‰Šé™¤ï¼ˆå¤ã„50%ï¼‰

---

## ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### P2.0å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

#### Aï¼ˆUIï¼‰
- [ ] `static/ui.js` ã‚’ä½œæˆã—ãŸ
- [ ] inline script ã‚’å…¨ã¦ ui.js ã«ç§»ã—ãŸ
- [ ] onclick å±æ€§ã‚’å…¨ã¦å‰Šé™¤ã—ãŸ
- [ ] id å±æ€§ã‚’è¿½åŠ ã—ãŸï¼ˆclearFiltersç­‰ï¼‰
- [ ] addEventListener ã§å‡¦ç†ã‚’è¿½åŠ ã—ãŸ
- [ ] index.htmx ã‹ã‚‰ inline script ã‚’å‰Šé™¤ã—ãŸ
- [ ] ui.js ã‚’ defer ã§èª­ã¿è¾¼ã‚“ã 
- [ ] grep ãƒã‚§ãƒƒã‚¯ãŒ 0 ä»¶ã«ãªã£ãŸ
- [ ] ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œç¢ºèªã—ãŸ
- [ ] Console ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ãªã„

#### Bï¼ˆrenderï¼‰
- [ ] `render.py` ã‚’ä½œæˆã—ãŸ
- [ ] app.py ã‹ã‚‰ HTML Rendering ã‚’ç§»æ¤ã—ãŸ
- [ ] å¾ªç’°import ã‚’é¿ã‘ãŸï¼ˆimport app ãªã—ï¼‰
- [ ] å¿…è¦ãªå€¤ã‚’å¼•æ•°ã§æ¸¡ã—ãŸ
- [ ] app.py ã‹ã‚‰ render_ é–¢æ•°ã‚’å‰Šé™¤ã—ãŸ
- [ ] app.py ã« import ã‚’è¿½åŠ ã—ãŸ
- [ ] å‘¼ã³å‡ºã—ç®‡æ‰€ã‚’ç½®æ›ã—ãŸ
- [ ] grep ãƒã‚§ãƒƒã‚¯ãŒ 0 ä»¶ã«ãªã£ãŸ
- [ ] ãƒ†ã‚¹ãƒˆãŒå…¨ã¦ pass ã—ãŸ

---

### P2.5å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

#### Phase 1: å®Ÿè£…å®Œäº†ï¼ˆâœ… ã¾ãŸã¯ â­ï¸ï¼‰

- [ ] app.py ã¸ã®å®Ÿè£…å®Œäº†ï¼ˆç´„484è¡Œï¼‰
- [ ] ä»»æ„åˆºã—Aå®Œäº†ï¼ˆapp.stateå„ªå…ˆå‚ç…§ï¼‰
- [ ] ä»»æ„åˆºã—Bå®Œäº†ï¼ˆenforceå¾Œãƒ¬ãƒãƒ¼ãƒˆæ–¹é‡ï¼‰
- [ ] ãƒ†ã‚¹ãƒˆ51æœ¬å…¨green
- [ ] CI/CDçµ±åˆå®Œäº†
- [ ] å¢ƒç•Œãƒãƒ¼ã‚«ãƒ¼è¨­ç½®

---

#### Phase 2: UIæ”¹ä¿®ï¼ˆâ­ï¸ å°†æ¥å®Ÿæ–½ï¼‰

- [ ] static/styles.css ä½œæˆ
- [ ] index.htmx ä¿®æ­£ï¼ˆ`<style>` â†’ `<link>`ï¼‰
- [ ] test_csp_static_compat.py è¿½åŠ 
- [ ] ãƒ†ã‚¹ãƒˆ54æœ¬å…¨greenç¢ºèª
- [ ] UIè¡¨ç¤ºç¢ºèª

**æ‰€è¦æ™‚é–“**: ç´„30åˆ†ã€œ1æ™‚é–“

---

#### Phase 3: CSP enforce ç§»è¡Œï¼ˆâ­ï¸ Phase 2å¾Œï¼‰

**Phase 3.1: report é‹ç”¨**
- [ ] CSP_MODE=report è¨­å®š
- [ ] å…¨æ©Ÿèƒ½å‹•ä½œç¢ºèª
- [ ] violation åæŸç¢ºèª
- [ ] 1æ—¥ã€œæ•°æ—¥ã®å®‰å®šé‹ç”¨

**Phase 3.2: enforce ç§»è¡Œ**
- [ ] CSP_MODE=enforce è¨­å®š
- [ ] å…¨æ©Ÿèƒ½å‹•ä½œç¢ºèª
- [ ] DevTools ã‚¨ãƒ©ãƒ¼ãªã—ç¢ºèª
- [ ] ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½OFFç¢ºèª
- [ ] 1é€±é–“ã€œ1ãƒ¶æœˆã®æœ¬ç•ªé‹ç”¨

**æ‰€è¦æ™‚é–“**: 1é€±é–“ã€œ1ãƒ¶æœˆï¼ˆé‹ç”¨æœŸé–“å«ã‚€ï¼‰

---

## ã¾ã¨ã‚

### P2.0ã®æˆæœ

âœ… **å®Œäº†äº‹é …**:
- inline script å®Œå…¨æ’é™¤
- onclick / hx-on å®Œå…¨æ’é™¤
- HTMLç”Ÿæˆã‚’ render.py ã«é›†ç´„
- å¾ªç’°import å›é¿
- ãƒ†ã‚¹ãƒˆå…¨é€š

**å·®åˆ†**:
- æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«: 2å€‹ï¼ˆui.js, render.pyï¼‰
- å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«: 2å€‹ï¼ˆindex.htmx, app.pyï¼‰
- å‰Šæ¸›è¡Œæ•°: ç´„200è¡Œï¼ˆapp.pyï¼‰

---

### P2.5ã®æˆæœ

âœ… **Phase 1 å®Œäº†äº‹é …**:
- CSPãƒãƒªã‚·ãƒ¼å®Ÿè£…ï¼ˆç´„484è¡Œï¼‰
- ãƒ†ã‚¹ãƒˆ51æœ¬å…¨green
- ä»»æ„åˆºã—Aãƒ»Bå®Œäº†
- CI/CDçµ±åˆ
- å¢ƒç•Œãƒãƒ¼ã‚«ãƒ¼è¨­ç½®

â­ï¸ **å°†æ¥ã®ã‚¿ã‚¹ã‚¯**:
- Phase 2: UIæ”¹ä¿®ï¼ˆ30åˆ†ã€œ1æ™‚é–“ï¼‰
- Phase 3: enforceç§»è¡Œï¼ˆ1é€±é–“ã€œ1ãƒ¶æœˆï¼‰

**å·®åˆ†**:
- è¿½åŠ è¡Œæ•°: ç´„484è¡Œï¼ˆapp.pyï¼‰
- ãƒ†ã‚¹ãƒˆè¿½åŠ : 32æœ¬ï¼ˆtest_csp_headers.py + test_audit_integrity.pyï¼‰

---

### æ³¨æ„äº‹é …ï¼ˆã¾ã¨ã‚ï¼‰

âš ï¸ **P2.0**:
- CDN fallback ã¯å‰Šé™¤æ¸ˆã¿ï¼ˆP2.5ã§å†æ¤œè¨ï¼‰
- htmx listener ã¯ top-level é…ç½®å¿…é ˆ
- render.py ã¯ app ã‚’ import ã—ãªã„

âš ï¸ **P2.5**:
- P0/P1é ˜åŸŸã¯çµ¶å¯¾ã«ç·¨é›†ä¸å¯
- UIæ”¹ä¿®å‰ã® enforce ç¦æ­¢
- åˆ‡ã‚Šæ›¿ãˆé †åºã¯å¿…ãš off â†’ report â†’ enforce

---

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

**P2.0å®Œäº†å¾Œ**:
- âœ… pytestå…¨é€šç¢ºèª
- âœ… æ‰‹å‹•å‹•ä½œç¢ºèª
- â­ï¸ P2.5 Phase 1 ã¸

**P2.5 Phase 1å®Œäº†å¾Œ**:
- âœ… ãƒ†ã‚¹ãƒˆ51æœ¬å…¨green
- âœ… CIçµ±åˆç¢ºèª
- â­ï¸ P2.5 Phase 2ï¼ˆUIæ”¹ä¿®ï¼‰ã¸

**P2.5 Phase 2å®Œäº†å¾Œ**:
- âœ… test_csp_static_compat.py å…¨green
- âœ… UIè¡¨ç¤ºç¢ºèª
- â­ï¸ P2.5 Phase 3.1ï¼ˆreporté‹ç”¨ï¼‰ã¸

**P2.5 Phase 3.2å®Œäº†å¾Œ**:
- âœ… 1é€±é–“ã€œ1ãƒ¶æœˆã®æœ¬ç•ªé‹ç”¨
- âœ… DevToolsã‚¨ãƒ©ãƒ¼ãªã—
- â­ï¸ P3 ã¸

---

**30_P2å¤‰æ›´ç‚¹ãƒ¡ãƒ¢_é‹ç”¨ã‚¬ã‚¤ãƒ‰.md - çµ‚ã‚ã‚Š**
