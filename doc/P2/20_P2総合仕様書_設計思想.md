# 20_P2総合仕様書_設計思想.md

**作成日**: 2026-01-03  
**対象フェーズ**: P2.0 (A+B) + P2.5 (CSP)  
**ステータス**: 統合完全版・設計確定

---

## 📋 目次

1. [設計概要](#設計概要)
2. [P2.0設計思想（A+B）](#p20設計思想ab)
3. [P2.5設計思想（CSP）](#p25設計思想csp)
4. [アーキテクチャ](#アーキテクチャ)
5. [設計判断と理由](#設計判断と理由)
6. [実装の歴史](#実装の歴史)
7. [テスト戦略](#テスト戦略)
8. [運用ガイド](#運用ガイド)
9. [FAQ](#faq)

---

## 設計概要

### P2全体の目的

**P2.0（A+B）**:
1. **A（UI tighten準備）**: inline script/style を外部ファイル化
2. **B（render集約）**: HTML生成を `app.py` から `render.py` に追放

**P2.5（CSP）**:
- Content Security Policy (CSP) によるXSS攻撃防止

**共通思想**:
- 段階的移行でリスク最小化
- 既存機能を壊さない
- テスト駆動で保証

---

### 実装規模

#### P2.0

| 項目 | 数値 |
|------|------|
| 新規ファイル | 2個（ui.js, render.py） |
| 変更ファイル | 2個（index.htmx, app.py） |
| 削除対象 | inline全排除 |
| テスト数 | 18本（既存全通） |

#### P2.5

| 項目 | 数値 |
|------|------|
| 追加行数 | 約484行（app.py） |
| テスト数 | 51本（Phase 1完了時点） |
| 主要関数 | 7個 |
| エンドポイント | 1個（/__csp_report） |
| 環境変数 | 4個 |
| 段階的移行 | 3段階（off/report/enforce） |

---

## P2.0設計思想（A+B）

### 基本方針

**目的**:
- CSP tighten への準備（inline排除）
- XSSレビューの容易化（HTML生成集約）

**原則**:
- "移動"が主目的（リファクタは後回し）
- 既存のAPI/レスポンス意味を変えない
- テスト全通必須

**禁止事項**:
- ❌ ついでリファクタ（命名美化、設計刷新）
- ❌ 循環import（render.py が app を import）
- ❌ HTMLの意図しない変更
- ❌ CDN fallback の復活
- ❌ htmx listener の配置換え

---

### A: UI tighten準備（inline排除）

#### 設計判断1: inline script の完全排除

**判断**:
```html
<!-- Before -->
<script>
  if(!window.htmx){
    document.write('<script src="/static/vendor/htmx.min.js"><\/script>');
  }
</script>

<!-- After -->
<!-- （削除） -->
```

**理由**:
- CSP `script-src 'self'` への移行準備
- `document.write` は defer で動かない
- CDN fallback は P2.5 で再検討

**代償**:
- CDN fallback の一時削除
- `/static/vendor/htmx.min.js` 必須

**利点**:
- inline script ゼロ（CSP準備完了）
- セキュリティ向上

---

#### 設計判断2: onclick / hx-on の完全排除

**判断**:
```html
<!-- Before -->
<button onclick="clearFilters()">Clear</button>

<!-- After -->
<button id="clearFilters">Clear</button>
```

**理由**:
- CSP `script-src 'self'` 要件
- inline handler は禁止

**実装方法**:
- addEventListener で処理
- DOMContentLoaded で初期化

**代償**:
- id 属性の追加が必要
- ui.js の肥大化

**利点**:
- イベント処理の集約
- デバッグ容易

---

#### 設計判断3: htmx listener の top-level配置

**判断**:
```javascript
// ui.js（top-level）
document.body.addEventListener('htmx:afterSwap', function(evt){
  // ...
});
```

**理由**:
- htmx の仕様要件
- top-level でないと動作しない

**禁止**:
```javascript
// ❌ DOMContentLoaded 内に入れると動かない
document.addEventListener('DOMContentLoaded', function(){
  document.body.addEventListener('htmx:afterSwap', ...);  // NG
});
```

**重要性**:
- これを守らないと filters refresh が動かない
- 微妙なバグになりやすい

---

#### 設計判断4: clearFilters の実物互換

**判断**:
```javascript
// 実物のIDに合わせる
document.getElementById('q').value = '';
document.getElementById('status').value = '';
document.getElementById('priority').value = '';
document.getElementById('since').value = '';
document.getElementById('until').value = '';
```

**理由**:
- 実装との完全互換性
- ID変更リスク回避

**注意**:
- 仮のIDで実装すると動かない
- 実物確認必須

---

#### 設計判断5: modal close の backdrop判定

**判断**:
```javascript
modal.addEventListener('click', function(e){
  // backdrop（modal自体）をクリックした場合のみ閉じる
  if(e.target === modal){
    closeModal();
  }
});
```

**理由**:
- modal 内のコンテンツクリックで閉じない
- UX改善

**代替案と却下理由**:
- **全クリックで閉じる**: modal内ボタンが使えない
- **backdrop専用要素**: DOM構造変更が必要

---

### B: render集約（HTML生成追放）

#### 設計判断6: render.py の新規作成

**判断**:
```python
# render.py（新規作成）
def render_notes_table(notes):
    # HTML生成
    ...
```

**理由**:
- HTML生成を1箇所に集約
- XSSレビューが容易
- app.py の肥大化防止

**配置**:
- repoRoot/render.py（app.py と同階層）

**利点**:
- HTML生成箇所が明確
- セキュリティレビュー容易

---

#### 設計判断7: 循環import の完全回避

**判断**:
```python
# render.py
# app は import しない ← 重要

def render_summary(data, allowed_statuses):
    # 引数で受け取る
    for st in allowed_statuses:
        ...
```

**理由**:
- 循環import は Python で厳禁
- ImportError の原因

**実装方法**:
- app.py → render.py: OK
- render.py → app.py: NG
- 必要な情報は引数で渡す

**代償**:
- 引数が増える可能性
- render_summary のみ `allowed_statuses` 引数追加

**利点**:
- 依存関係が明確
- テスト容易

---

#### 設計判断8: 引数化の最小化

**判断**:
```python
# 引数化が必要なのは render_summary のみ
def render_summary(data, allowed_statuses):
    ...

# 他の render_* は既存のまま
def render_notes_table(notes):
    ...
```

**理由**:
- app.py への影響を最小化
- 差分を小さく保つ

**方針**:
- ALLOWED_STATUS など定数が必要な場合のみ引数化
- 他は既存のシグネチャ維持

**利点**:
- 移行コスト最小
- レビュー容易

---

## P2.5設計思想（CSP）

### 基本方針

**目的**: Content Security Policy (CSP) によるXSS攻撃防止

**設計思想**:
1. **契約駆動**: テストで契約を機械化
2. **段階的移行**: off → report → enforce
3. **プロキシ対応**: Vercel/リバプロで動作
4. **DoS耐性**: サンプリング、サイズ上限
5. **例外経路保証**: 全経路でCSPヘッダ
6. **監査台帳保護**: P0/P1領域に一切触らない
7. **ループ停止**: 境界マーカー + CIチェック
8. **割に合わない攻撃は無視**: enforce後はレポート不要

---

### CSP設計判断

#### 設計判断9: CSP_MODE の3段階設計

**判断**:
```python
CSP_MODE: Literal["off", "report", "enforce"]
```

- **off**: CSPヘッダを出さない
- **report**: Content-Security-Policy-Report-Only
- **enforce**: Content-Security-Policy

**理由**:

**段階的移行でリスク最小化**:
1. off: 開発環境で CSP なし
2. report: 本番環境で違反を観測（UI破損なし）
3. enforce: 本番環境で違反をブロック（本番適用）

**代替案と却下理由**:
- **2段階（off/enforce）**: 一発本番は危険（UI破損リスク）
- **4段階以上**: 複雑すぎる、運用コスト高

**運用方針**:
```
開発環境: off
本番環境（観測）: report（1日〜数日）
本番環境（適用）: enforce（1週間〜1ヶ月）
```

---

#### 設計判断10: style-src 'self'（'unsafe-inline' なし）

**判断**:
```python
"style-src 'self' 'report-sample'",
```

**'unsafe-inline' を使わない**

**理由**:

**セキュリティ優先**:
- XSS攻撃を防ぐ
- inline style は外部CSS化が必要

**代償**:
- UI改修が必要（index.htmx の `<style>` タグ除去）

**利点**:
- CSS/Tailwind選択を後回しにできる
- 将来の変更に柔軟

**代替案と却下理由**:
- **nonce方式**: 複雑すぎる（サーバー側で毎リクエストnonce生成）
- **'unsafe-inline'**: セキュリティリスク（XSS攻撃可能）

---

#### 設計判断11: Reporting API の任意ON

**判断**:
```python
CSP_USE_REPORTING_API: bool = False  # デフォルトOFF
```

- report-uri: 常に有効（旧式だが広く対応）
- report-to: 任意ON（新式、CSP3推奨）

**理由**:

**運用コストが高い**:
- Reporting-Endpoints ヘッダの構築コスト
- ネットワーク帯域の消費

**report-uri だけでも機能する**:
- 旧式だが広く対応している
- 必要十分

**必要な時だけON**:
- `CSP_USE_REPORTING_API=1` で有効化
- 観測期間のみ使用

**代替案と却下理由**:
- **常にON**: ネットワークコスト高
- **完全OFF**: 新式ブラウザで機能しない

---

#### 設計判断12: サンプリング（60秒に1回）

**判断**:
```python
# 同一 violation を60秒に1回だけログ出力
_csp_violation_samples: dict[tuple[str, str], float] = {}
```

**理由**:

**ログ課金を抑える**:
- 同じ violation が大量発生してもログが爆発しない
- 60秒に1回だけログ出力

**ログ可観測性を保つ**:
- 違反の種類は全て記録される
- サンプリング辞書のサイズも記録

**メモリ安全**:
- 辞書上限: 1000件
- 超過時は古い50%を削除

**代替案と却下理由**:
- **サンプリングなし**: ログ課金爆発（DoS攻撃に脆弱）
- **完全無視**: 違反の種類が不明（運用不可）

---

#### 設計判断13: /__csp_report の no-auth

**判断**:
```python
# 認証なしで受信
@app.post("/__csp_report")
async def _handle_csp_report(request: Request):
    # ...
```

**理由**:

**ブラウザからの自動送信**:
- ブラウザが自動的に送信
- 認証トークンを持たない

**DoS耐性で防御**:
- サイズ上限（100KB）
- Content-Typeチェック
- サンプリング

**代替案と却下理由**:
- **認証必須**: ブラウザが送信できない（機能不全）
- **IPフィルタ**: CDN/プロキシ経由で無効

---

#### 設計判断14: 任意刺しA（app.state 優先参照）

**判断**:
```python
# lifespan（startup）で構築
app.state.csp_policy = _build_csp_policy(settings)

# middleware で参照
csp_policy = request.app.state.csp_policy
```

**理由**:

**パフォーマンス改善**:
- 毎リクエストで `get_settings()` を呼ばない
- 毎リクエストで `_build_csp_policy()` を呼ばない

**筋が通る**:
- lifespan で構築した値を実際に使う
- 設定は起動時に固定（実行中は不変）

**代替案と却下理由**:
- **毎リクエストbuild**: 無駄（設定は不変）
- **グローバル変数**: テスト時に汚染リスク

**効果**:
- リクエスト処理時間の短縮
- メモリ使用量の削減

---

#### 設計判断15: 任意刺しB（enforce後レポート不要）

**判断**:
```python
# report mode: report-uri / report-to を付与
if settings.csp_report_uri and settings.csp_mode == "report":
    directives.append(f"report-uri {settings.csp_report_uri}")
```

**enforce mode ではレポート機能OFF**

**理由**:

**運用コスト抑制**:
- enforce後は違反を止めるだけ
- レポート収集は不要

**思想**:
- 「割に合わない攻撃は無視」
- 観測期間（report）で違反を潰す
- enforce後は静かに防御

**方針**:
```
report mode:  report-uri ✅ / Reporting-Endpoints ✅（観測のため）
enforce mode: report-uri ❌ / Reporting-Endpoints ❌（運用コスト抑制）
```

**代替案と却下理由**:
- **enforce後もレポート継続**: ログ/ネットワークコスト高
- **reportのみ運用**: enforce しないとXSS防げない

**効果**:
- ログサーバーの負荷軽減
- ネットワーク帯域の節約

---

## アーキテクチャ

### P2.0アーキテクチャ

#### ファイル構成

```
vnext-ledger/
├── app.py（HTML生成を削除）
├── render.py（新規：HTML生成集約）
└── static/
    ├── index.htmx（inline排除）
    ├── ui.js（新規：JS集約）
    └── vendor/
        └── htmx.min.js
```

#### 依存関係

```
app.py → render.py（import）
render.py → app.py（import禁止）

index.htmx → ui.js（script src）
ui.js → htmx（window.htmx）
```

#### データフロー（HTML生成）

```
Browser
  ↓ GET /notes/table
app.py: notes_table()
  ↓ _get_notes()
  ↓ notes = [...]
  ↓ render_notes_table(notes)  ← render.py を呼び出し
render.py: render_notes_table()
  ↓ HTML文字列生成
  ↓ return "<table>...</table>"
app.py: HTMLResponse(html)
  ↓
Browser
```

---

### P2.5アーキテクチャ

#### 全体構成図

```
┌─────────────────────────────────────────────┐
│            FastAPI Application              │
├─────────────────────────────────────────────┤
│  lifespan (startup)                         │
│  ├─ init_settings()                         │
│  ├─ check_p1_contract_gate()                │
│  ├─ init_db()                               │
│  └─ CSP policy pre-build → app.state       │← 任意刺しA
├─────────────────────────────────────────────┤
│  Middleware                                 │
│  └─ _apply_security_headers_to_response()   │
│      ├─ app.state から CSP取得 ← 任意刺しA  │
│      ├─ CSP ヘッダ付与                      │
│      ├─ Reporting-Endpoints（report時のみ）│← 任意刺しB
│      ├─ その他セキュリティヘッダ            │
│      └─ キャッシュ制御                      │
├─────────────────────────────────────────────┤
│  Exception Handlers                         │
│  ├─ HTTPException handler                   │
│  └─ General exception handler               │
│      └─ _apply_security_headers_to_response()│
├─────────────────────────────────────────────┤
│  Endpoints                                  │
│  ├─ /__csp_report (POST)                    │
│  │   ├─ DoS耐性（サイズ上限）              │
│  │   ├─ サンプリング（60秒に1回）          │
│  │   └─ ログ注入防止                       │
│  ├─ / (GET)                                 │
│  ├─ /notes/* (GET/PATCH)                    │
│  ├─ /scan (POST)                            │
│  └─ /export/* (GET)                         │
└─────────────────────────────────────────────┘
```

---

#### データフロー（CSP違反レポート）

```
Browser
  │
  │ CSP violation detected
  │
  ├─ (1) report-uri: /__csp_report    ← 旧式（広く対応）
  ├─ (2) report-to: csp-endpoint      ← 新式（CSP3）
  │
  ↓ POST /__csp_report
  │
Server (_handle_csp_report)
  │
  ├─ (1) DoS防御
  │   ├─ Content-Type チェック
  │   └─ サイズ上限チェック（100KB）
  │
  ├─ (2) サンプリング
  │   ├─ 辞書キー: (blocked_uri, violated_directive)
  │   ├─ 60秒に1回だけログ出力
  │   └─ 辞書上限: 1000件（超過時50%削除）
  │
  ├─ (3) ログ注入防止
  │   ├─ 改行除去
  │   └─ 200文字切り捨て
  │
  └─ (4) ログ出力
      └─ INFO: CSP violation: blocked-uri=..., violated-directive=...
```

---

## 設計判断と理由

### P2.0の主要判断（まとめ）

| No | 判断 | 理由 | 代償 |
|----|------|------|------|
| 1 | inline script 完全排除 | CSP準備 | CDN fallback 削除 |
| 2 | onclick / hx-on 排除 | CSP準備 | id属性追加必要 |
| 3 | htmx listener top-level | htmx仕様 | DOMContentLoaded不可 |
| 4 | clearFilters 実物互換 | 動作保証 | ID変更リスク |
| 5 | modal backdrop判定 | UX改善 | イベント判定コスト |
| 6 | render.py 新規作成 | HTML集約 | ファイル増加 |
| 7 | 循環import 完全回避 | Python要件 | 引数増加 |
| 8 | 引数化最小化 | 差分最小 | 将来的に増える可能性 |

---

### P2.5の主要判断（まとめ）

| No | 判断 | 理由 | 代償 |
|----|------|------|------|
| 9 | CSP_MODE 3段階 | 段階的移行 | 運用複雑化 |
| 10 | 'unsafe-inline' なし | セキュリティ優先 | UI改修必要 |
| 11 | Reporting API 任意ON | 運用コスト抑制 | 設定項目増加 |
| 12 | サンプリング60秒 | ログ課金抑制 | リアルタイム性低下 |
| 13 | /__csp_report no-auth | ブラウザ送信 | DoS攻撃リスク |
| 14 | app.state 優先参照 | パフォーマンス | 実装複雑化 |
| 15 | enforce後レポート不要 | 運用コスト抑制 | 攻撃検知不能 |

---

## 実装の歴史

### P2.0の進化

#### v2.0.0（初期版）
- inline script 排除
- onclick 排除
- render.py 作成

#### v2.1.0（実物互換）
- clearFilters の対象ID を実物に合わせた（q/status/priority/since/until）
- scan後の filters refresh（afterRequest）を追加
- result の 10秒消去を classList.remove('show') に修正

#### v2.1.1（最終版）
- afterRequest の判定を path.includes('/scan') に変更（実物互換）
- afterSwap で show を付けてから 10秒後に外す（実物互換）
- closeModal 関数を追加（show 外す + display none + innerHTML 空）
- Done Criteria の grep を python one-liner に統一（書類の矛盾解消）

---

### P2.5の進化（段階的"刺し"）

#### 刺し①②③④（CSP基盤）

1. **刺し①**: Reporting API 完全対応
   - report-uri（旧式）+ report-to（新式）
   - Reporting-Endpoints ヘッダ（絶対URL）
   - プロキシ環境対応

2. **刺し②**: ヘッダ排他性の実装保証
   - Content-Security-Policy と Report-Only を混在させない

3. **刺し③**: style-src 'self' の決定
   - 'unsafe-inline' を使わない（セキュリティ優先）

4. **刺し④**: 'report-sample' の追加
   - CSP違反のサンプルコードを取得（運用改善）

---

#### 刺しA・B・C（地雷除去）

1. **刺しA**: サンプリング辞書の上限とログ注入防止
   - 辞書上限1000件、超過時50%削除
   - ログ注入攻撃防止（改行除去）

2. **刺しB**: forwarded host のサニタイズ
   - ヘッダ注入攻撃防止
   - 正規表現で安全な文字のみ許可

3. **刺しC**: 例外経路の完全保証
   - exception handler でCSPヘッダ付与

---

#### 刺し①②③④（最後の4発）

1. **刺し①**: _get_external_origin の契約確定
   - X-Forwarded-Proto/Host 優先
   - フォールバック保証

2. **刺し②**: / に Vary: Accept 付与
   - CDN/キャッシュ事故防止

3. **刺し③**: 二重実装の完全削除
   - middleware と exception handler の共通化（85行削減）

4. **刺し④**: max_age を report/enforce で分ける
   - report: 1時間、enforce: 7日

---

#### 刺し⑤⑥⑦⑧（監査保護）

1. **刺し⑤**: 監査データが消えない契約テスト
   - note_events / evidence / scan_log の存在確認

2. **刺し⑥**: Accept分岐に Vary: Accept
   - / と /notes/{slug} にVary付与

3. **刺し⑦**: CSP report endpoint は DB に触らない
   - ログ出力のみ、サンプリング辞書はメモリ内

4. **刺し⑧**: P2.5編集範囲を封印
   - 境界マーカー + CIチェック

---

#### 刺し0・①・②・③（ループ停止）

1. **刺し0**: 編集許可範囲をマーカーで固定
2. **刺し①**: 監査欠損を契約テストで封じる
3. **刺し②**: CSP tighten の契約
4. **刺し③**: Reporting API は観測期間だけON

---

#### 任意刺しA・B（美しく〆）

1. **任意刺しA**: app.state 優先参照（パフォーマンス）
2. **任意刺しB**: enforce後レポート不要（運用コスト）

---

## テスト戦略

### 契約駆動テスト

**原則**: テストが通れば本番で動く保証

**実装方針**:
- 各テストが1つの契約を検証
- 契約違反は即座にCIで検知
- 件数や中身の断定はしない（壊れやすい）

---

### P2.0テスト戦略

**テスト数**: 18本（既存全通）

**戦略**:
- 既存テストを壊さない
- inline排除の機械チェック
- 手動スモークテスト

**チェック項目**:
1. inline script: 0件
2. onclick / hx-on: 0件
3. render_ 関数（app.py）: 0件
4. import app（render.py）: 0件
5. pytest: 全green

---

### P2.5テストカテゴリ（51本）

#### CSPヘッダテスト（27本）

| カテゴリ | テスト数 | 内容 |
|---------|---------|------|
| 基本動作 | 3本 | off/report/enforce |
| ヘッダ排他性 | 2本 | report と enforce 混在防止 |
| Reporting API | 3本 | 絶対URL、プロキシ対応 |
| DoS耐性 | 4本 | サイズ上限、サンプリング |
| エラー応答 | 2本 | 401/403/500 でCSP |
| キャッシュ制御 | 2本 | Vary: Accept |
| プロキシ対応 | 2本 | フォールバック、注入防止 |
| tighten契約 | 2本 | enforce排他性 |
| その他 | 7本 | - |

---

#### 監査整合性テスト（5本）

| テスト | 内容 |
|-------|------|
| test_note_events_table_exists_and_readable | note_events 存在確認 |
| test_evidence_table_exists_and_readable | evidence 存在確認 |
| test_scan_log_table_exists_and_readable | scan_log 存在確認 |
| test_export_endpoints_accessible | export系動作確認 |
| test_scan_endpoint_writes_to_db | scan動作確認 |

**目的**: P2.5実装がP0/P1の監査台帳を破壊しないことを保証

---

#### その他テスト（19本）

- export_and_scan: 4本
- p1_hardening: 5本
- p1_ledger_pollution_contract: 2本
- patch_notes: 3本
- prod_gate: 3本
- scan_encoding_errors: 1本
- slug_unicode_ui: 1本

---

### fixtureの役割

**reset_app_state** (autouse=True):
- 全テスト実行前後で状態をリセット
- グローバル変数のクリーンアップ
- ルート復元（テスト用エンドポイント削除）

**効果**:
- テスト間の状態汚染を防ぐ
- P3/P4で状態が増えても安全

---

## 運用ガイド

### P2.0運用

**運用状態**: ✅ 完了

**確認事項**:
- inline script: 0件
- onclick / hx-on: 0件
- render_ 関数（app.py）: 0件
- import app（render.py）: 0件
- テスト: 全green

**注意点**:
- CDN fallback は削除済み
- htmx.min.js の存在必須

---

### P2.5運用

#### 現在の運用状態（2026-01-03時点）

**環境変数**:
```bash
MODE=prod
CSP_MODE=report  # 観測モード継続中
CSP_USE_REPORTING_API=1
CSP_REPORT_URI=/__csp_report
```

**運用方針**:
- ✅ CSP_MODE=report で違反を観測
- ⏭️ UI改修（inline style 外部化）待ち
- ⏭️ UI改修完了後に CSP_MODE=enforce へ移行

---

#### モニタリング

**ログ監視**:
```bash
# CSP違反の確認
grep "CSP violation" <log_file>

# サンプリング辞書のサイズ確認
grep "sampling map size" <log_file>
```

**メトリクス**:
- CSP違反の数（種類別）
- サンプリング辞書のサイズ
- `/__csp_report` のリクエスト数

**アラート設定**:
- 意図しない violation が発生した場合
- サンプリング辞書が1000件に到達した場合

---

#### トラブル対応

**問題1: 意図しない違反が発生**

**症状**: サーバーログに想定外の violation

**対処**:
1. ログで violated-directive を確認
2. blocked-uri で原因特定
3. inline style/script を外部ファイル化
4. 再テスト

---

**問題2: Reporting-Endpoints が http**

**症状**: レポートURLがhttpになる

**対処**:
1. プロキシ設定確認
2. `x-forwarded-proto: https` が渡されているか確認
3. _get_external_origin() のログ確認

---

**問題3: サンプリング辞書が増え続ける**

**症状**: メモリ使用量が増加

**対処**:
1. ログで violation の種類を確認
2. 共通の原因を特定
3. 修正してから再起動

**想定動作**:
- 上限1000件で自動削除（古い50%）

---

## FAQ

### P2.0関連

#### Q1: CDN fallback はどうするか？

**A**: P2では削除、P2.5で再検討します。

**理由**:
- `document.write` は defer で動かない
- CSP準備のため一時削除

**代替**:
- `/static/vendor/htmx.min.js` を必須にする

---

#### Q2: onclick を全部 addEventListener にする必要があるか？

**A**: Yes。CSP `script-src 'self'` の要件です。

**理由**:
- inline handler は禁止
- CSP enforce時に動作しない

---

#### Q3: render.py が app を import してはいけない理由は？

**A**: 循環import になるためです。

**エラー例**:
```
ImportError: cannot import name 'get_settings' from partially initialized module 'app'
```

**対策**:
- 必要な情報は引数で渡す

---

### P2.5関連

#### Q4: CSP_MODE=off のままでいいか？

**A**: No。off は開発環境専用です。

**理由**:
- XSS攻撃を防げない
- 本番環境では最低でも report モードが必要

---

#### Q5: UI改修せずに enforce できるか？

**A**: No。inline style が残っているため UI が壊れます。

**対処**:
1. Phase 2（UI改修）を完了
2. test_csp_static_compat.py が全green
3. その後 enforce へ移行

---

#### Q6: enforce後にレポートは不要か？

**A**: Yes（任意刺しBの方針）。

**理由**:
- enforce後は違反を止めるだけ
- レポート収集は運用コスト高
- 観測期間（report）で違反を潰す

**方針**:
- 「割に合わない攻撃は無視」

---

#### Q7: サンプリングを無効化できるか？

**A**: No。無効化は推奨しません。

**理由**:
- ログ課金が爆発する
- DoS攻撃に脆弱

**代替案**:
- サンプリング間隔を調整（60秒→変更）
- ログレベルを調整（INFO→WARNING）

---

#### Q8: P0/P1領域を編集していいか？

**A**: No。絶対に編集不可です。

**理由**:
- 監査台帳が壊れる
- P2.5の契約違反

**保証**:
- 境界マーカーで保護
- CIチェックで検知（check_p25_boundary.py）

---

#### Q9: Reporting API は必須か？

**A**: No。任意ONです（デフォルトOFF）。

**理由**:
- report-uri だけでも機能する
- 運用コストが高い

**有効化**:
```bash
CSP_USE_REPORTING_API=1
```

---

#### Q10: なぜ60秒サンプリングか？

**A**: ログ課金とリアルタイム性のバランスです。

**方針**:
- 同じ violation が連続発生してもログが爆発しない
- 違反の種類は全て記録される

**調整**:
- コード内の60を変更可能
- 推奨: 30秒〜300秒

---

## まとめ

### P2.0の成果

- ✅ inline script 完全排除
- ✅ onclick / hx-on 完全排除
- ✅ HTML生成を render.py に集約
- ✅ 循環import 回避
- ✅ テスト全通

**次のステップ**: P2.5実装

---

### P2.5の成果

- ✅ CSPポリシー実装（約484行）
- ✅ テスト51本全green
- ✅ 任意刺しA・B完了
- ✅ CI/CD統合
- ✅ 境界マーカー設置

**次のステップ**: Phase 2（UI改修）→ Phase 3（enforce移行）

---

### 設計思想の継承

**P2.0 → P2.5**:
- 段階的移行の思想継承
- テスト駆動の徹底
- 既存機能の保護

**P2.5 → P3**:
- 監査台帳の保護継続
- 境界マーカーの活用
- 契約駆動テストの拡充

---

**20_P2総合仕様書_設計思想.md - 終わり**
