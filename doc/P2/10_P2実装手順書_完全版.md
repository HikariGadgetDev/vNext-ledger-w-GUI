# 10_P2å®Ÿè£…æ‰‹é †æ›¸_å®Œå…¨ç‰ˆ.md

**ä½œæˆæ—¥**: 2026-01-03  
**å¯¾è±¡ãƒ•ã‚§ãƒ¼ã‚º**: P2.0 (A+B) + P2.5 (CSP)  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: çµ±åˆå®Œå…¨ç‰ˆ

---

## ğŸ“‹ ç›®æ¬¡

### Part 1: P2.0å®Ÿè£…ï¼ˆA+Bï¼‰
1. [P2.0å‰ææ¡ä»¶](#p20å‰ææ¡ä»¶)
2. [P2.0ã‚¹ã‚³ãƒ¼ãƒ—](#p20ã‚¹ã‚³ãƒ¼ãƒ—)
3. [P2.0å®Œäº†æ¡ä»¶Done Criteria](#p20å®Œäº†æ¡ä»¶done-criteria)
4. [P2.0å®Ÿè£…æ‰‹é †](#p20å®Ÿè£…æ‰‹é †)
5. [P2.0æ©Ÿæ¢°ãƒã‚§ãƒƒã‚¯](#p20æ©Ÿæ¢°ãƒã‚§ãƒƒã‚¯)
6. [P2.0å—ã‘å…¥ã‚Œãƒ†ã‚¹ãƒˆ](#p20å—ã‘å…¥ã‚Œãƒ†ã‚¹ãƒˆ)
7. [P2.0ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#p20ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

### Part 2: P2.5å®Ÿè£…ï¼ˆCSPï¼‰
8. [P2.5ãƒ•ã‚§ãƒ¼ã‚ºæ¦‚è¦](#p25ãƒ•ã‚§ãƒ¼ã‚ºæ¦‚è¦)
9. [P2.5 Phase 1: å®Ÿè£…](#p25-phase-1-å®Ÿè£…)
10. [P2.5 Phase 2: UIæ”¹ä¿®](#p25-phase-2-uiæ”¹ä¿®)
11. [P2.5 Phase 3: enforceç§»è¡Œ](#p25-phase-3-enforceç§»è¡Œ)
12. [P2.5å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ](#p25å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ)

---

# Part 1: P2.0å®Ÿè£…ï¼ˆA+Bï¼‰

## P2.0å‰ææ¡ä»¶

### å¿…é ˆç’°å¢ƒ
- Python 3.13+
- FastAPI 0.115+
- pytest
- P1å®Ÿè£…å®Œäº†ï¼ˆ`python -m pytest -q` ãŒå…¨é€šï¼‰

### ç¢ºèªã‚³ãƒãƒ³ãƒ‰
```bash
# ãƒ†ã‚¹ãƒˆå…¨é€šç¢ºèª
python -m pytest -q
# â†’ 18 passedï¼ˆã¾ãŸã¯ç¾æ™‚ç‚¹ã®ãƒ†ã‚¹ãƒˆæ•°å…¨é€šï¼‰

# P1å®Œäº†ç¢ºèª
grep -c "P1 COMPLETE" README.md  # ã¾ãŸã¯è©²å½“ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
```

### P2.0ã®åŸºæœ¬æ–¹é‡

**ç›®çš„**:
- A: UI tightenæº–å‚™ï¼ˆinlineæ’é™¤ï¼‰
- B: renderé›†ç´„ï¼ˆHTMLç”Ÿæˆã‚’ app.py ã‹ã‚‰è¿½æ”¾ï¼‰

**ç¦æ­¢äº‹é …**:
- âŒ ã¤ã„ã§ãƒªãƒ•ã‚¡ã‚¯ã‚¿ï¼ˆå‘½åç¾åŒ–ã€è¨­è¨ˆåˆ·æ–°ã€MVCåŒ–ã€DBå¤‰æ›´ï¼‰
- âŒ å¾ªç’°importï¼ˆrender.py ãŒ app ã‚’ importï¼‰
- âŒ HTMLã®æ„å›³ã—ãªã„å¤‰æ›´ï¼ˆã‚¿ã‚°æ§‹é€ ã€æ–‡è¨€ã€ä¸¦ã³é †ï¼‰
- âŒ CDN fallback ã®å¾©æ´»ï¼ˆdocument.writeï¼‰
- âŒ htmx listener ã®é…ç½®æ›ãˆï¼ˆtop-levelå›ºå®šï¼‰

**åŸå‰‡**:
- "ç§»å‹•"ãŒä¸»ç›®çš„ï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ã¯å¾Œå›ã—ï¼‰
- æ—¢å­˜ã®API/ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ„å‘³ã‚’å¤‰ãˆãªã„
- ãƒ†ã‚¹ãƒˆå…¨é€šå¿…é ˆ

---

## P2.0ã‚¹ã‚³ãƒ¼ãƒ—

### A: UI tightenæº–å‚™ï¼ˆinlineæ’é™¤ï¼‰

**ç›®æ¨™**: CSP `script-src 'self'` / `style-src 'self'` ã¸ã®ç§»è¡Œæº–å‚™

**ä½œæ¥­å†…å®¹**:
1. inline `<script>...</script>` ã‚’ã‚¼ãƒ­ã«ã™ã‚‹
2. `onclick=` / `hx-on:` ã‚’ã‚¼ãƒ­ã«ã™ã‚‹
3. JS ã‚’ `static/ui.js` ã«é›†ç´„ã—ã€`defer` ã§èª­ã¿è¾¼ã‚€

**æˆæœç‰©**:
- `static/ui.js`ï¼ˆæ–°è¦ä½œæˆï¼‰
- `static/index.htmx`ï¼ˆinlineæ’é™¤ï¼‰

---

### B: renderé›†ç´„ï¼ˆHTMLç”Ÿæˆè¿½æ”¾ï¼‰

**ç›®æ¨™**: HTMLç”Ÿæˆã‚’1ç®‡æ‰€ã«é›†ç´„ã—ã¦XSSãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®¹æ˜“ã«ã™ã‚‹

**ä½œæ¥­å†…å®¹**:
1. `app.py` ã‹ã‚‰ HTMLæ–‡å­—åˆ—ç”Ÿæˆã‚’å…¨è¿½æ”¾
2. æ–°è¦ `render.py` ã«é›†ç´„
3. å¾ªç’°importå›é¿ï¼ˆrender.py ã¯ app ã‚’ import ã—ãªã„ï¼‰

**æˆæœç‰©**:
- `render.py`ï¼ˆæ–°è¦ä½œæˆï¼‰
- `app.py`ï¼ˆrender_* é–¢æ•°ã‚’å…¨å‰Šé™¤ï¼‰

---

## P2.0å®Œäº†æ¡ä»¶ï¼ˆDone Criteriaï¼‰

### A: UIå®Œäº†æ¡ä»¶

#### æ©Ÿæ¢°ãƒã‚§ãƒƒã‚¯

**PowerShell**:
```powershell
# inlineæ®‹å­˜ç¢ºèª
Select-String .\static\index.htmx -Pattern '<script(?![^>]*src=)|onclick=|hx-on:' | Measure-Object | Select-Object -ExpandProperty Count
# â†’ 0 ã§ã‚ã‚‹ã“ã¨
```

**bash/zshï¼ˆpython one-linerï¼‰**:
```bash
python - <<'PY'
import re, pathlib
s = pathlib.Path("static/index.htmx").read_text(encoding="utf-8")
m = re.findall(r'<script(?![^>]*\bsrc=)|onclick=|hx-on:', s, flags=re.I)
print(len(m))
PY
# â†’ 0 ã§ã‚ã‚‹ã“ã¨
```

#### æ‰‹å‹•ç¢ºèªï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰

- [ ] scan â†’ filters refresh ãŒå‹•ã
- [ ] result ãŒ 10ç§’ã§æ¶ˆãˆã‚‹
- [ ] clear filters ãŒåŠ¹ã
- [ ] modal èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
- [ ] Console ã‚¨ãƒ©ãƒ¼ãªã—

---

### B: renderå®Œäº†æ¡ä»¶

#### æ©Ÿæ¢°ãƒã‚§ãƒƒã‚¯

**PowerShell**:
```powershell
# app.py ã« render_ é–¢æ•°ãŒæ®‹ã£ã¦ãªã„ã‹
(Select-String .\app.py -Pattern 'def render_').Count
# â†’ 0 ã§ã‚ã‚‹ã“ã¨

# render.py ãŒ app ã‚’ import ã—ã¦ãªã„ã‹
(Select-String .\render.py -Pattern 'import app').Count
# â†’ 0 ã§ã‚ã‚‹ã“ã¨
```

**bash/zsh**:
```bash
# app.py ã« render_ é–¢æ•°ãŒæ®‹ã£ã¦ãªã„ã‹
grep -c 'def render_' app.py
# â†’ 0 ã§ã‚ã‚‹ã“ã¨

# render.py ãŒ app ã‚’ import ã—ã¦ãªã„ã‹
grep -c 'import app' render.py
# â†’ 0 ã§ã‚ã‚‹ã“ã¨
```

#### ãƒ†ã‚¹ãƒˆ

```bash
python -m pytest -q
# â†’ å…¨ã¦ pass ã™ã‚‹ã“ã¨
```

---

## P2.0å®Ÿè£…æ‰‹é †

### Step A-1: static/ui.js ã‚’è¿½åŠ 

**ç›®çš„**: inline `<script>` ã®å†…å®¹ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã«ç§»ã™

#### 1. æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ« `static/ui.js` ã‚’ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: `static/ui.js`

#### 2. inline script ã‚’å…¨ã¦ç§»æ¤

**a. CDN fallback ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆå‰Šé™¤ï¼‰**

ç¾åœ¨ index.htmx ã® `<head>` ã«ã‚ã‚‹ä»¥ä¸‹ã¯**å‰Šé™¤**:
```javascript
if(!window.htmx){
  document.write('<script src="/static/vendor/htmx.min.js"><\/script>');
}
```

**ç†ç”±**:
- `document.write` ã¯ `defer` ã§èª­ã‚€ã¨å‹•ã‹ãªã„
- CSP enforceæ™‚ã«å‹•ä½œã—ãªã„
- CDN fallback ã¯ P2.5 ã§å†æ¤œè¨

**å¯¾ç­–**: å¸¸ã« `/static/vendor/htmx.min.js` ã‚’èª­ã‚€å‰æã«ã™ã‚‹

---

**b. 10ç§’è‡ªå‹•æ¶ˆå»ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆbody æœ«å°¾ã‹ã‚‰ç§»å‹•ï¼‰**

**é‡è¦**: show ã‚’ä»˜ã‘ã¦ã‹ã‚‰ 10ç§’å¾Œã«å¤–ã™ï¼ˆå®Ÿç‰©äº’æ›ï¼‰

```javascript
// ui.js ã«è¿½åŠ 
document.body.addEventListener('htmx:afterSwap', function(evt){
  if(evt.detail.target.id === 'result'){
    const resultDiv = document.getElementById('result');
    if(!resultDiv) return;
    resultDiv.classList.add('show');
    setTimeout(() => resultDiv.classList.remove('show'), 10000);
  }
});
```

**æ³¨æ„**:
- `htmx:afterSwap` ã¯top-levelï¼ˆdocument.bodyç›´ä¸‹ï¼‰ã«é…ç½®
- ç§»å‹•ã™ã‚‹ã¨å‹•ä½œã—ãªã„

---

**c. scanå¾Œã® filters refreshï¼ˆafterRequestï¼‰**

**é‡è¦**: path ã‚’è¦‹ã¦ /scan ãªã‚‰ filters refreshï¼ˆå®Ÿç‰©äº’æ›ï¼‰

```javascript
// ui.js ã«è¿½åŠ 
document.body.addEventListener('htmx:afterRequest', function(evt){
  const path = evt.detail?.pathInfo?.requestPath || evt.detail?.requestConfig?.path || "";
  if(path.includes('/scan')){
    const el = document.getElementById('filters');
    if(el && window.htmx){
      htmx.trigger(el, 'refresh');
    }
  }
});
```

**æ³¨æ„**:
- `htmx:afterRequest` ã‚‚top-levelé…ç½®
- pathåˆ¤å®šã¯ `includes('/scan')` ã§å®Ÿç‰©äº’æ›

---

#### 3. onclick ã‚’å‰Šé™¤ã—ã¦ addEventListener ã§å‡¦ç†

**closeModal é–¢æ•°ï¼ˆå®Ÿç‰©äº’æ›ï¼‰**:
```javascript
// ui.js ã«è¿½åŠ 

// closeModal é–¢æ•°ï¼ˆshow å¤–ã™ + display none + innerHTML ç©ºï¼‰
function closeModal(){
  const m = document.getElementById('modal');
  if(!m) return;
  m.classList.remove('show');
  m.style.display = 'none';
  m.innerHTML = "";
}
```

**DOMContentLoaded ã§åˆæœŸåŒ–**:
```javascript
document.addEventListener('DOMContentLoaded', function(){
  // Clear filters ãƒœã‚¿ãƒ³
  // é‡è¦: å®Ÿç‰©ã® ID ã¯ q/status/priority/since/until
  var clearBtn = document.getElementById('clearFilters');
  if(clearBtn){
    clearBtn.addEventListener('click', function(){
      document.getElementById('q').value = '';
      document.getElementById('status').value = '';
      document.getElementById('priority').value = '';
      document.getElementById('since').value = '';
      document.getElementById('until').value = '';
      // filters ã‚’ refresh
      if(window.htmx){
        htmx.trigger(document.getElementById('filters'), 'refresh');
      }
    });
  }
  
  // Modal backdrop ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  var modal = document.getElementById('modal');
  if(modal){
    modal.addEventListener('click', function(e){
      // backdropï¼ˆmodalè‡ªä½“ï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã®ã¿é–‰ã˜ã‚‹
      if(e.target === modal){
        closeModal();
      }
    });
  }
});
```

**æ³¨æ„**:
- clear filters ã®å¯¾è±¡IDã¯å®Ÿç‰©ã«åˆã‚ã›ã‚‹ï¼ˆq/status/priority/since/untilï¼‰
- modal close ã¯ backdrop ã®ã¿ï¼ˆå†…éƒ¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯å½±éŸ¿ã‚’å—ã‘ãªã„ï¼‰

---

#### æœ€çµ‚çš„ãª ui.js ã®æ§‹é€ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: `static/ui.js`

```javascript
// static/ui.js

// === htmx listenersï¼ˆtop-levelå¿…é ˆï¼‰ ===

// 10ç§’è‡ªå‹•æ¶ˆå»ï¼ˆshow ã‚’ä»˜ã‘ã¦ã‹ã‚‰ 10ç§’å¾Œã«å¤–ã™ï¼‰
document.body.addEventListener('htmx:afterSwap', function(evt){
  if(evt.detail.target.id === 'result'){
    const resultDiv = document.getElementById('result');
    if(!resultDiv) return;
    resultDiv.classList.add('show');
    setTimeout(() => resultDiv.classList.remove('show'), 10000);
  }
});

// scan å®Œäº†å¾Œã« filters ã‚’ refreshï¼ˆpath ã‚’è¦‹ã¦åˆ¤å®šï¼‰
document.body.addEventListener('htmx:afterRequest', function(evt){
  const path = evt.detail?.pathInfo?.requestPath || evt.detail?.requestConfig?.path || "";
  if(path.includes('/scan')){
    const el = document.getElementById('filters');
    if(el && window.htmx){
      htmx.trigger(el, 'refresh');
    }
  }
});

// === Helper functions ===

// closeModal é–¢æ•°ï¼ˆshow å¤–ã™ + display none + innerHTML ç©ºï¼‰
function closeModal(){
  const m = document.getElementById('modal');
  if(!m) return;
  m.classList.remove('show');
  m.style.display = 'none';
  m.innerHTML = "";
}

// === DOMContentLoaded ã§åˆæœŸåŒ– ===

document.addEventListener('DOMContentLoaded', function(){
  // Clear filtersï¼ˆå®Ÿç‰©ã® ID: q/status/priority/since/untilï¼‰
  var clearBtn = document.getElementById('clearFilters');
  if(clearBtn){
    clearBtn.addEventListener('click', function(){
      document.getElementById('q').value = '';
      document.getElementById('status').value = '';
      document.getElementById('priority').value = '';
      document.getElementById('since').value = '';
      document.getElementById('until').value = '';
      // filters ã‚’ refresh
      if(window.htmx){
        htmx.trigger(document.getElementById('filters'), 'refresh');
      }
    });
  }
  
  // Modal close on backdrop click
  var modal = document.getElementById('modal');
  if(modal){
    modal.addEventListener('click', function(e){
      if(e.target === modal){
        closeModal();
      }
    });
  }
});
```

---

### Step A-2: static/index.htmx ã‚’æœ€å°å·®åˆ†ã§ä¿®æ­£

**ç›®çš„**: inline script ã‚’å‰Šé™¤ã—ã€ui.js ã‚’èª­ã¿è¾¼ã‚€

#### 1. head å†…ã® inline scriptï¼ˆCDN fallbackï¼‰ã‚’å‰Šé™¤

**å‰Šé™¤å‰**:
```html
<script>
if(!window.htmx){
  document.write('<script src="/static/vendor/htmx.min.js"><\/script>');
}
</script>
```

**å‰Šé™¤å¾Œ**:
```html
<!-- ï¼ˆä½•ã‚‚ãªã—ï¼‰ -->
```

---

#### 2. body æœ«å°¾ã® inline script ã‚’å‰Šé™¤

**å‰Šé™¤å‰**:
```html
<script>
document.body.addEventListener('htmx:afterSwap', function(e){
  // ...
});
</script>
```

**å‰Šé™¤å¾Œ**:
```html
<!-- ï¼ˆä½•ã‚‚ãªã—ï¼‰ -->
```

---

#### 3. htmx ã®å¾Œã« ui.js ã‚’è¿½åŠ 

**head å†…ï¼ˆã¾ãŸã¯ body æœ«å°¾ï¼‰ã«è¿½åŠ **:
```html
<script src="/static/vendor/htmx.min.js"></script>
<script src="/static/ui.js" defer></script>
```

**æ³¨æ„**:
- htmx â†’ ui.js ã®é †åºã‚’å®ˆã‚‹
- `defer` å±æ€§ã‚’ä»˜ã‘ã‚‹ï¼ˆDOMContentLoadedå¾Œã«å®Ÿè¡Œï¼‰

---

#### 4. onclick å±æ€§ã‚’å‰Šé™¤

**Clear filters ãƒœã‚¿ãƒ³**:

**å‰Šé™¤å‰**:
```html
<button onclick="clearFilters()">Clear filters</button>
```

**å‰Šé™¤å¾Œ**:
```html
<button id="clearFilters">Clear filters</button>
```

**Modalï¼ˆbackdrop ã® onclick å‰Šé™¤ï¼‰**:

**å‰Šé™¤å‰**:
```html
<div id="modal" onclick="closeModal()">...</div>
```

**å‰Šé™¤å¾Œ**:
```html
<div id="modal">...</div>
```

**æ³¨æ„**:
- modal close ã¯ ui.js ã® addEventListener ã§å‡¦ç†
- backdropï¼ˆmodal è‡ªä½“ï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã®ã¿é–‰ã˜ã‚‹
- modal å†…ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯å½±éŸ¿ã‚’å—ã‘ãªã„

---

### Step B-1: render.py ã‚’æ–°è¦ä½œæˆã—ã€HTML Rendering ã‚’ç§»æ¤

**ç›®çš„**: app.py ã‹ã‚‰ HTMLç”Ÿæˆã‚’å…¨ã¦è¿½æ”¾

#### 1. æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ« `render.py` ã‚’ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: `render.py`ï¼ˆrepoRoot/app.py ã¨åŒéšå±¤ï¼‰

---

#### 2. app.py ã®ã€ŒHTML Renderingã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç§»æ¤

**ç§»æ¤å¯¾è±¡ã®é–¢æ•°**:
- `render_notes_table(notes, ...)`
- `render_note_detail(note, ...)`
- `render_summary(data, ...)`
- `render_metrics(data, ...)`
- `render_scan_result(...)`
- `root()` å†…ã® fallback HTMLï¼ˆ`render_no_ui()` ã¨ã—ã¦åˆ†é›¢ï¼‰

---

#### 3. å¾ªç’°importå›é¿ã®å…·ä½“çš„æ–¹æ³•

**âŒ ã‚„ã£ã¦ã¯ã„ã‘ãªã„**:
```python
# render.py
import app  # â† å¾ªç’°importç™ºç”Ÿ

def render_summary(data):
    statuses = app.ALLOWED_STATUS  # â† ãƒ€ãƒ¡
```

**âœ… æ­£ã—ã„æ–¹æ³•**:
```python
# render.py
# app ã¯ import ã—ãªã„

def render_summary(data, allowed_statuses):
    # å¼•æ•°ã§å—ã‘å–ã‚‹
    for st in allowed_statuses:
        ...
```

**app.py å´**:
```python
from render import render_summary

@app.get("/export/summary")
def export_summary(request: Request):
    data = ...
    return render_summary(data, allowed_statuses=ALLOWED_STATUS)
```

---

#### 4. å…·ä½“çš„ãªç§»æ¤ä¾‹

**ãƒ•ã‚¡ã‚¤ãƒ«**: `render.py`

```python
# render.py
from html import escape as esc
from urllib.parse import quote

def render_notes_table(notes):
    """Notes table HTML generation"""
    # æ—¢å­˜ã®å®Ÿè£…ã‚’ãã®ã¾ã¾ç§»ã™
    # ALLOWED_STATUS/PRIORITIES ã¯ app.py ã‹ã‚‰å‚ç…§ã—ãªã„ãŸã‚ã€
    # å¼•æ•°ã§æ¸¡ã™å¿…è¦ãŒã‚ã‚‹å ´åˆã®ã¿è¿½åŠ 
    # ï¼ˆç¾çŠ¶ã¯ä¸è¦ã®å¯èƒ½æ€§ã‚ã‚Šï¼‰
    ...

def render_note_detail(note):
    """Note detail HTML generation"""
    # æ—¢å­˜ã®å®Ÿè£…ã‚’ãã®ã¾ã¾ç§»ã™
    ...

def render_summary(data, allowed_statuses):
    """
    Summary HTML generation
    
    Args:
        data: Summary data dict
        allowed_statuses: List of valid status valuesï¼ˆapp.ALLOWED_STATUS ã‚’æ¸¡ã™ï¼‰
    """
    # æ—¢å­˜ã®å®Ÿè£…ã‚’ç§»ã™
    # app.ALLOWED_STATUS â†’ allowed_statusesï¼ˆå¼•æ•°ï¼‰ã«ç½®æ›
    ...

def render_metrics(data):
    """Metrics HTML generation"""
    # app ã®å®šæ•°ã«ä¾å­˜ã—ãªã„ã®ã§ãã®ã¾ã¾
    ...

def render_scan_result(added, updated, stale_marked, revived_count, scan_type):
    """Scan result HTML generation"""
    # æ—¢å­˜ã®å®Ÿè£…ã‚’ãã®ã¾ã¾ç§»ã™
    ...

def render_no_ui():
    """Fallback HTML when index.htmx not found"""
    return """
    <!DOCTYPE html>
    <html><body>
    <h1>vnext-ledger</h1>
    <p>No UI found. API only.</p>
    </body></html>
    """
```

---

#### 5. app.py ã¸ã®å½±éŸ¿ã‚’æœ€å°åŒ–

**æ–¹é‡**:
- é–¢æ•°ã®ã‚·ã‚°ãƒãƒãƒ£ã¯å¤‰ãˆãªã„ï¼ˆå¼•æ•°è¿½åŠ ã¯æœ€å°é™ï¼‰
- **å¼•æ•°åŒ–ãŒå¿…è¦ãªã®ã¯ render_summary ã® ALLOWED_STATUS ã®ã¿**
- ä»–ã® render_* ã¯æ—¢å­˜ã®ã¾ã¾ç§»æ¤ï¼ˆå¼•æ•°è¿½åŠ ä¸è¦ï¼‰

---

### Step B-2: app.py ã¯ import ã—ã¦å‘¼ã¶ã ã‘ã«ã™ã‚‹

**ç›®çš„**: app.py ã‹ã‚‰ HTMLç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã‚’å‰Šé™¤

#### 1. app.py å…ˆé ­ä»˜è¿‘ã« import è¿½åŠ 

```python
# app.py
from render import (
    render_notes_table,
    render_note_detail,
    render_summary,
    render_metrics,
    render_scan_result,
    render_no_ui,
)
```

---

#### 2. HTML Rendering ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤

```python
# app.py

# ============================================================
# HTML Rendering
# ============================================================
# â† ã“ã®ä¸‹ã® def render_* ã‚’å…¨ã¦å‰Šé™¤
```

---

#### 3. å‘¼ã³å‡ºã—ç®‡æ‰€ã‚’1:1ã§ç½®æ›

**render_notes_tableï¼ˆå¼•æ•°å¤‰æ›´ãªã—ï¼‰**:
```python
@app.get("/notes/table")
def notes_table(request: Request, ...):
    notes = _get_notes(...)
    return HTMLResponse(render_notes_table(notes))
```

**render_summaryï¼ˆALLOWED_STATUS ã‚’æ¸¡ã™ï¼‰**:
```python
@app.get("/export/summary")
def export_summary(request: Request):
    data = ...
    return HTMLResponse(
        render_summary(data, allowed_statuses=ALLOWED_STATUS)
    )
```

**ãã®ä»–ã® render_*ï¼ˆå¼•æ•°å¤‰æ›´ãªã—ï¼‰**:
- `render_note_detail(note)` â†’ ãã®ã¾ã¾
- `render_metrics(data)` â†’ ãã®ã¾ã¾
- `render_scan_result(...)` â†’ ãã®ã¾ã¾

---

#### 4. root() ã® fallback ä¿®æ­£

**Before**:
```python
@app.get("/")
def root(request: Request):
    ui_path = STATIC_DIR / "index.htmx"
    if not ui_path.exists():
        return HTMLResponse("""
        <!DOCTYPE html>
        <html><body>
        <h1>vnext-ledger</h1>
        ...
        """)
    ...
```

**After**:
```python
@app.get("/")
def root(request: Request):
    ui_path = STATIC_DIR / "index.htmx"
    if not ui_path.exists():
        return HTMLResponse(render_no_ui())
    ...
```

---

## P2.0æ©Ÿæ¢°ãƒã‚§ãƒƒã‚¯

### grep ãƒã‚§ãƒƒã‚¯

**PowerShell**:
```powershell
# app.py ã« render_ é–¢æ•°ãŒæ®‹ã£ã¦ãªã„ã‹
(Select-String .\app.py -Pattern 'def render_').Count
# â†’ 0 ã§ã‚ã‚‹ã“ã¨

# render.py ãŒ app ã‚’ import ã—ã¦ãªã„ã‹
(Select-String .\render.py -Pattern 'import app').Count
# â†’ 0 ã§ã‚ã‚‹ã“ã¨

# index.htmx ã« inline script ãŒæ®‹ã£ã¦ãªã„ã‹
Select-String .\static\index.htmx -Pattern '<script(?![^>]*src=)|onclick=|hx-on:' | Measure-Object | Select-Object -ExpandProperty Count
# â†’ 0 ã§ã‚ã‚‹ã“ã¨
```

**bash/zsh**:
```bash
# app.py ã« render_ é–¢æ•°ãŒæ®‹ã£ã¦ãªã„ã‹
grep -c 'def render_' app.py
# â†’ 0 ã§ã‚ã‚‹ã“ã¨

# render.py ãŒ app ã‚’ import ã—ã¦ãªã„ã‹
grep -c 'import app' render.py
# â†’ 0 ã§ã‚ã‚‹ã“ã¨

# index.htmx ã« inline script ãŒæ®‹ã£ã¦ãªã„ã‹
# æ³¨æ„: grep ã¯è² ã®å…ˆèª­ã¿ãŒä½¿ãˆãªã„ãŸã‚ã€python one-liner ã‚’ä½¿ç”¨
python - <<'PY'
import re, pathlib
s = pathlib.Path("static/index.htmx").read_text(encoding="utf-8")
m = re.findall(r'<script(?![^>]*\bsrc=)|onclick=|hx-on:', s, flags=re.I)
print(len(m))
PY
# â†’ 0 ã§ã‚ã‚‹ã“ã¨
```

---

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```bash
python -m pytest -q
# â†’ å…¨ã¦ pass ã™ã‚‹ã“ã¨
```

---

## P2.0å—ã‘å…¥ã‚Œãƒ†ã‚¹ãƒˆ

### ã‚µãƒ¼ãƒãƒ¼èµ·å‹•

```bash
# PowerShell
$env:MODE="local"
python -m uvicorn app:app --reload

# bash/zsh
MODE=local python -m uvicorn app:app --reload
```

---

### ãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèª

#### 1. http://127.0.0.1:8000/ ã‚’é–‹ã
- [ ] UI ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨

#### 2. scan å®Ÿè¡Œ
- [ ] scan ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™
- [ ] filters ãŒ refresh ã•ã‚Œã‚‹ã“ã¨
- [ ] result ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨

#### 3. result è‡ªå‹•æ¶ˆå»
- [ ] result ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒ 10ç§’å¾Œã«æ¶ˆãˆã‚‹ã“ã¨

#### 4. Clear filters
- [ ] Clear filters ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™
- [ ] filter æ¡ä»¶ãŒå…¨ã¦ã‚¯ãƒªã‚¢ã•ã‚Œã‚‹ã“ã¨
- [ ] notes table ãŒ refresh ã•ã‚Œã‚‹ã“ã¨

#### 5. Modalï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
- [ ] modal ã‚’é–‹ã
- [ ] èƒŒæ™¯ï¼ˆbackdropï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯
- [ ] modal ãŒé–‰ã˜ã‚‹ã“ã¨
- [ ] modal å†…ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚é–‰ã˜ãªã„ã“ã¨

---

### Console ã‚¨ãƒ©ãƒ¼ç¢ºèª

```
F12 â†’ Console
â†’ ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ãªã„ã“ã¨
```

---

## P2.0ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Q1: ui.js ãŒèª­ã¿è¾¼ã¾ã‚Œãªã„

**ç¢ºèª**:
```bash
# ãƒ–ãƒ©ã‚¦ã‚¶ã® Network ã‚¿ãƒ–ã§ç¢ºèª
# http://127.0.0.1:8000/static/ui.js
# â†’ 200 OK ã«ãªã£ã¦ã‚‹ã‹
```

**å¯¾ç­–**:
```python
# app.py ã® StaticFiles è¨­å®šã‚’ç¢ºèª
app.mount("/static", StaticFiles(directory=STATIC_DIR), name="static")
```

---

### Q2: htmx ãŒå‹•ã‹ãªã„

**ç¢ºèª**:
```javascript
// ãƒ–ãƒ©ã‚¦ã‚¶ã® Console ã§ç¢ºèª
console.log(window.htmx);
// â†’ object ãŒè¿”ã£ã¦ãã‚‹ã‹
```

**å¯¾ç­–**:
- htmx.min.js ãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã‚‹ã‹ç¢ºèª
- script ã‚¿ã‚°ã®é †åºã‚’ç¢ºèªï¼ˆhtmx â†’ ui.js ã®é †ï¼‰

---

### Q3: clearFilters ãŒå‹•ã‹ãªã„

**ç¢ºèª**:
```javascript
// ãƒ–ãƒ©ã‚¦ã‚¶ã® Console ã§ç¢ºèª
document.getElementById('clearFilters');
// â†’ button è¦ç´ ãŒè¿”ã£ã¦ãã‚‹ã‹
```

**å¯¾ç­–**:
- button ã« `id="clearFilters"` ãŒä»˜ã„ã¦ã‚‹ã‹ç¢ºèª
- DOMContentLoaded ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è¦ç´ ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª

---

### Q4: ãƒ†ã‚¹ãƒˆãŒè½ã¡ã‚‹

**ç¢ºèª**:
```bash
python -m pytest -v
# â†’ ã©ã®ãƒ†ã‚¹ãƒˆãŒè½ã¡ã¦ã‚‹ã‹ç¢ºèª
```

**å¯¾ç­–**:
- render.py ã¸ã®ç§»æ¤æ¼ã‚ŒãŒãªã„ã‹ç¢ºèª
- å¾ªç’°import ãŒç™ºç”Ÿã—ã¦ãªã„ã‹ç¢ºèª
- å¼•æ•°ã®æ¸¡ã—å¿˜ã‚ŒãŒãªã„ã‹ç¢ºèª

---

### Q5: å¾ªç’°import ã‚¨ãƒ©ãƒ¼

**ã‚¨ãƒ©ãƒ¼ä¾‹**:
```
ImportError: cannot import name 'get_settings' from partially initialized module 'app'
```

**åŸå› **: render.py ãŒ app ã‚’ import ã—ã¦ã„ã‚‹

**å¯¾ç­–**:
```python
# NG
from app import get_settings

# OK
def render_something(..., mode: str):
    # å¼•æ•°ã§å¿…è¦ãªæƒ…å ±ã‚’æ¸¡ã™
```

---

## P2.0å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Aï¼ˆUIï¼‰
- [ ] `static/ui.js` ã‚’ä½œæˆã—ãŸ
- [ ] inline script ã‚’å…¨ã¦ ui.js ã«ç§»ã—ãŸ
- [ ] onclick å±æ€§ã‚’å…¨ã¦å‰Šé™¤ã—ãŸ
- [ ] id å±æ€§ã‚’è¿½åŠ ã—ãŸï¼ˆclearFiltersç­‰ï¼‰
- [ ] addEventListener ã§å‡¦ç†ã‚’è¿½åŠ ã—ãŸ
- [ ] index.htmx ã‹ã‚‰ inline script ã‚’å‰Šé™¤ã—ãŸ
- [ ] ui.js ã‚’ defer ã§èª­ã¿è¾¼ã‚“ã 
- [ ] grep ãƒã‚§ãƒƒã‚¯ãŒ 0 ä»¶ã«ãªã£ãŸ
- [ ] ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œç¢ºèªã—ãŸ
- [ ] Console ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ãªã„

### Bï¼ˆrenderï¼‰
- [ ] `render.py` ã‚’ä½œæˆã—ãŸ
- [ ] app.py ã‹ã‚‰ HTML Rendering ã‚’ç§»æ¤ã—ãŸ
- [ ] å¾ªç’°import ã‚’é¿ã‘ãŸï¼ˆimport app ãªã—ï¼‰
- [ ] å¿…è¦ãªå€¤ã‚’å¼•æ•°ã§æ¸¡ã—ãŸ
- [ ] app.py ã‹ã‚‰ render_ é–¢æ•°ã‚’å‰Šé™¤ã—ãŸ
- [ ] app.py ã« import ã‚’è¿½åŠ ã—ãŸ
- [ ] å‘¼ã³å‡ºã—ç®‡æ‰€ã‚’ç½®æ›ã—ãŸ
- [ ] grep ãƒã‚§ãƒƒã‚¯ãŒ 0 ä»¶ã«ãªã£ãŸ
- [ ] ãƒ†ã‚¹ãƒˆãŒå…¨ã¦ pass ã—ãŸ

---

# Part 2: P2.5å®Ÿè£…ï¼ˆCSPï¼‰

## P2.5ãƒ•ã‚§ãƒ¼ã‚ºæ¦‚è¦

### å…¨ä½“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

```
Phase 1: P2.5å®Ÿè£…å®Œäº†    âœ… å®Ÿè£…ã®ã¿ï¼ˆç´„1-2æ™‚é–“ï¼‰
  â”‚
  â”œâ”€ app.py å®Ÿè£…ï¼ˆç´„484è¡Œè¿½åŠ ï¼‰
  â”œâ”€ ä»»æ„åˆºã—Aãƒ»Bå®Ÿè£…
  â”œâ”€ ãƒ†ã‚¹ãƒˆè¿½åŠ 
  â””â”€ CI/CDçµ±åˆ

Phase 2: UIæ”¹ä¿®         â­ï¸ å°†æ¥å®Ÿæ–½ï¼ˆP3ç§»è¡Œå‰ï¼‰
  â”‚
  â”œâ”€ inline style å¤–éƒ¨CSSåŒ–
  â”œâ”€ test_csp_static_compat.py è¿½åŠ ï¼ˆ3æœ¬ï¼‰
  â””â”€ ãƒ†ã‚¹ãƒˆ54æœ¬å…¨greenç¢ºèª

Phase 3: CSP enforceç§»è¡Œ â­ï¸ UIæ”¹ä¿®å¾Œ
  â”‚
  â”œâ”€ CSP_MODE=report é‹ç”¨ï¼ˆ1æ—¥ã€œæ•°æ—¥ï¼‰
  â”œâ”€ é•åãƒ¬ãƒãƒ¼ãƒˆåæŸç¢ºèª
  â””â”€ CSP_MODE=enforce ç§»è¡Œ
```

---

### å‰ææ¡ä»¶

**å®Ÿæ–½æ¸ˆã¿**:
- âœ… P2.0å®Ÿè£…å®Œäº†
- âœ… P1å®Ÿè£…å®Œäº†
- âœ… ãƒ†ã‚¹ãƒˆç’°å¢ƒæ•´å‚™

**å¿…è¦ç’°å¢ƒ**:
- Python 3.13+
- FastAPI 0.115+
- pytest 9.0+

---

## P2.5 Phase 1: å®Ÿè£…

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: å®Ÿè£…ã®ã¿ï¼ˆé‹ç”¨ã¯å¾Œå›ã—ï¼‰

### å®Ÿè£…å†…å®¹

#### app.py ã¸ã®è¿½åŠ å®Ÿè£…

**è¿½åŠ ç®‡æ‰€**:
1. Line 1127-1175: `_build_csp_policy()` é–¢æ•°
2. Line 1183-1207: lifespan ã§ã®CSPãƒãƒªã‚·ãƒ¼äº‹å‰æ§‹ç¯‰
3. Line 1241-1326: `_apply_security_headers_to_response()` é–¢æ•°
4. Line 1328-1437: CSP report endpoint (`/__csp_report`)
5. Line 1439-1481: `_get_external_origin()` é–¢æ•°

**ä¸»è¦æ©Ÿèƒ½**:
1. CSPãƒãƒªã‚·ãƒ¼å‹•çš„ç”Ÿæˆ
2. Reporting APIå¯¾å¿œï¼ˆreport-uri / report-toï¼‰
3. ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°æ©Ÿèƒ½ï¼ˆ60ç§’ã«1å›ï¼‰
4. DoSè€æ€§ï¼ˆã‚µã‚¤ã‚ºä¸Šé™ãƒ»Content-Typeãƒã‚§ãƒƒã‚¯ï¼‰
5. ä¾‹å¤–çµŒè·¯ä¿è¨¼ï¼ˆexception handlerçµ±åˆï¼‰

---

#### å®Ÿè£…Step 1: _build_csp_policy() é–¢æ•°

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app.py`  
**å ´æ‰€**: Line 1127-1175ï¼ˆP0/P1 CORE ã®å¾Œï¼‰

**å®Ÿè£…å†…å®¹**:
```python
def _build_csp_policy(settings) -> str:
    """
    CSPãƒãƒªã‚·ãƒ¼æ–‡å­—åˆ—ã‚’ç”Ÿæˆã™ã‚‹ã€‚
    
    è¨­è¨ˆåˆ¤æ–­:
    - style-src 'self' / script-src 'self'ï¼ˆ'unsafe-inline' ãªã—ï¼‰
    - report-uri / report-to ã¯ report mode ã®ã¿ï¼ˆä»»æ„åˆºã—Bï¼‰
    """
    directives = [
        "default-src 'self'",
        "style-src 'self'",
        "script-src 'self'",
        "img-src 'self' data:",
        "font-src 'self'",
        "connect-src 'self'",
        "frame-ancestors 'none'",
        "base-uri 'self'",
        "form-action 'self'",
    ]
    
    # ä»»æ„åˆºã—B: report-uri / report-to ã¯è¦³æ¸¬æœŸé–“ï¼ˆreport modeï¼‰ã®ã¿
    # enforceå¾Œã¯é•åã‚’æ­¢ã‚ã‚‹ã ã‘ã§ã€ãƒ¬ãƒãƒ¼ãƒˆåé›†ã¯ä¸è¦ï¼ˆé‹ç”¨ã‚³ã‚¹ãƒˆæŠ‘åˆ¶ï¼‰
    if settings.csp_report_uri and settings.csp_mode == "report":
        directives.append(f"report-uri {settings.csp_report_uri}")
        
        if settings.csp_use_reporting_api:
            directives.append("report-to csp-endpoint")
    
    return "; ".join(directives)
```

**é‡è¦ãƒã‚¤ãƒ³ãƒˆ**:
- 'unsafe-inline' ã‚’å«ã‚ãªã„ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å„ªå…ˆï¼‰
- report-uri / report-to ã¯ report mode ã®ã¿ï¼ˆä»»æ„åˆºã—Bï¼‰

---

#### å®Ÿè£…Step 2: lifespan ã§ã®CSPãƒãƒªã‚·ãƒ¼äº‹å‰æ§‹ç¯‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app.py`  
**å ´æ‰€**: Line 1183-1207ï¼ˆæ—¢å­˜ã®lifespané–¢æ•°ã‚’æ‹¡å¼µï¼‰

**å®Ÿè£…å†…å®¹**:
```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    """
    ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã®åˆæœŸåŒ–
    """
    # æ—¢å­˜ã®åˆæœŸåŒ–
    init_settings()
    check_p1_contract_gate()
    init_db()
    
    # ä»»æ„åˆºã—A: app.state ã«CSPãƒãƒªã‚·ãƒ¼ã‚’äº‹å‰æ§‹ç¯‰
    # ï¼ˆæ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ _build_csp_policy() ã‚’å‘¼ã°ãªã„ï¼‰
    settings = get_settings()
    app.state.csp_mode = settings.csp_mode
    app.state.csp_policy = _build_csp_policy(settings)
    app.state.mode = settings.mode
    app.state.csp_use_reporting_api = settings.csp_use_reporting_api
    app.state.csp_report_uri = settings.csp_report_uri
    
    yield
```

**åŠ¹æœ**:
- æ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ `get_settings()` ã‚’å‘¼ã°ãªã„
- æ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ `_build_csp_policy()` ã‚’å‘¼ã°ãªã„
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„

---

#### å®Ÿè£…Step 3: _apply_security_headers_to_response() é–¢æ•°

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app.py`  
**å ´æ‰€**: Line 1241-1326

**å®Ÿè£…å†…å®¹**:
```python
def _apply_security_headers_to_response(response: Response, request: Request):
    """
    ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ä»˜ä¸ã™ã‚‹ã€‚
    
    middleware + exception handler ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ï¼ˆä¾‹å¤–çµŒè·¯ä¿è¨¼ï¼‰ã€‚
    """
    # ä»»æ„åˆºã—A: app.state ã‹ã‚‰ CSPå–å¾—ï¼ˆæ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§æ§‹ç¯‰ã—ãªã„ï¼‰
    csp_mode = request.app.state.csp_mode
    csp_policy = request.app.state.csp_policy
    mode = request.app.state.mode
    csp_use_reporting_api = request.app.state.csp_use_reporting_api
    csp_report_uri = request.app.state.csp_report_uri
    
    # CSPãƒ˜ãƒƒãƒ€ä»˜ä¸
    if csp_mode == "enforce":
        response.headers["Content-Security-Policy"] = csp_policy
    elif csp_mode == "report":
        response.headers["Content-Security-Policy-Report-Only"] = csp_policy
    
    # Reporting-Endpoints ãƒ˜ãƒƒãƒ€ï¼ˆreport mode ã®ã¿ï¼‰â† ä»»æ„åˆºã—B
    if csp_mode == "report" and csp_use_reporting_api and csp_report_uri:
        origin = _get_external_origin(request)
        endpoint_url = f"{origin}{csp_report_uri}"
        response.headers["Reporting-Endpoints"] = f'csp-endpoint="{endpoint_url}"'
    
    # ãã®ä»–ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€
    response.headers["X-Content-Type-Options"] = "nosniff"
    response.headers["X-Frame-Options"] = "DENY"
    response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ¶å¾¡
    if mode == "prod":
        response.headers["Cache-Control"] = "no-store, max-age=0"
```

**middleware ã¸ã®çµ±åˆ**:
```python
@app.middleware("http")
async def security_headers_middleware(request: Request, call_next):
    response = await call_next(request)
    _apply_security_headers_to_response(response, request)
    return response
```

**exception handler ã¸ã®çµ±åˆ**:
```python
@app.exception_handler(HTTPException)
async def http_exception_handler(request: Request, exc: HTTPException):
    response = JSONResponse(
        status_code=exc.status_code,
        content={"detail": exc.detail}
    )
    _apply_security_headers_to_response(response, request)
    return response

@app.exception_handler(Exception)
async def general_exception_handler(request: Request, exc: Exception):
    response = JSONResponse(
        status_code=500,
        content={"detail": "Internal server error"}
    )
    _apply_security_headers_to_response(response, request)
    return response
```

---

#### å®Ÿè£…Step 4: /__csp_report endpoint

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app.py`  
**å ´æ‰€**: Line 1328-1437

**å®Ÿè£…å†…å®¹**:
```python
# CSP violation ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°è¾æ›¸ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰
_csp_violation_samples = {}

@app.post("/__csp_report")
async def _handle_csp_report(request: Request):
    """
    CSP violation ãƒ¬ãƒãƒ¼ãƒˆã‚’å—ä¿¡ã™ã‚‹ã€‚
    
    DoSè€æ€§:
    - ã‚µã‚¤ã‚ºä¸Šé™: 100KB
    - Content-Type ãƒã‚§ãƒƒã‚¯
    - ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°: åŒä¸€violation ã‚’60ç§’ã«1å›ã ã‘ãƒ­ã‚°å‡ºåŠ›
    """
    # Content-Type ãƒã‚§ãƒƒã‚¯
    ct = request.headers.get("Content-Type", "")
    if "application/csp-report" not in ct and "application/json" not in ct:
        return Response(status_code=204)
    
    # ã‚µã‚¤ã‚ºä¸Šé™ãƒã‚§ãƒƒã‚¯ï¼ˆ100KBï¼‰
    try:
        body = await request.body()
        if len(body) > 100 * 1024:
            return Response(status_code=204)
    except Exception:
        return Response(status_code=204)
    
    # JSONè§£æ
    try:
        data = json.loads(body)
    except Exception:
        return Response(status_code=204)
    
    # violation æƒ…å ±å–å¾—
    report = data.get("csp-report", {})
    blocked_uri = report.get("blocked-uri", "")
    violated_directive = report.get("violated-directive", "")
    
    # ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼ˆ60ç§’ã«1å›ï¼‰
    key = (blocked_uri, violated_directive)
    now = time.time()
    
    global _csp_violation_samples
    last_time = _csp_violation_samples.get(key, 0)
    
    if now - last_time < 60:
        # 60ç§’ä»¥å†…ã®åŒä¸€violation ã¯ã‚¹ã‚­ãƒƒãƒ—
        return Response(status_code=204)
    
    # è¾æ›¸ä¸Šé™ãƒã‚§ãƒƒã‚¯ï¼ˆ1000ä»¶ã€è¶…éæ™‚50%å‰Šé™¤ï¼‰
    if len(_csp_violation_samples) > 1000:
        # å¤ã„50%ã‚’å‰Šé™¤
        sorted_items = sorted(_csp_violation_samples.items(), key=lambda x: x[1])
        keep_items = sorted_items[len(sorted_items)//2:]
        _csp_violation_samples = dict(keep_items)
    
    # æ›´æ–°
    _csp_violation_samples[key] = now
    
    # ãƒ­ã‚°å‡ºåŠ›ï¼ˆæ³¨å…¥é˜²æ­¢: æ”¹è¡Œé™¤å»ã€200æ–‡å­—åˆ‡ã‚Šæ¨ã¦ï¼‰
    blocked_uri_safe = blocked_uri.replace("\n", "").replace("\r", "")[:200]
    violated_directive_safe = violated_directive.replace("\n", "").replace("\r", "")[:200]
    
    logger.info(
        f"CSP violation: blocked-uri={blocked_uri_safe}, "
        f"violated-directive={violated_directive_safe}"
    )
    
    return Response(status_code=204)
```

---

#### å®Ÿè£…Step 5: _get_external_origin() é–¢æ•°

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app.py`  
**å ´æ‰€**: Line 1439-1481

**å®Ÿè£…å†…å®¹**:
```python
def _get_external_origin(request: Request) -> str:
    """
    å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹ã‚ªãƒªã‚¸ãƒ³ã‚’å–å¾—ã™ã‚‹ã€‚
    
    Vercel/ãƒªãƒãƒ—ãƒ­å¯¾å¿œ:
    - X-Forwarded-Proto / X-Forwarded-Host ã‚’å„ªå…ˆ
    - ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼ˆãƒ—ãƒ­ãƒˆã‚³ãƒ«/ãƒ›ã‚¹ãƒˆã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯ï¼‰
    """
    # ãƒ—ãƒ­ãƒˆã‚³ãƒ«å–å¾—ï¼ˆX-Forwarded-Proto å„ªå…ˆï¼‰
    proto = request.headers.get("X-Forwarded-Proto", "")
    if not proto:
        proto = request.url.scheme
    
    proto = sanitize_proto(proto)
    
    # ãƒ›ã‚¹ãƒˆå–å¾—ï¼ˆX-Forwarded-Host å„ªå…ˆï¼‰
    host = request.headers.get("X-Forwarded-Host", "")
    if not host:
        host = request.headers.get("Host", "localhost")
    
    host = sanitize_host(host)
    
    return f"{proto}://{host}"

def sanitize_proto(proto: str) -> str:
    """ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚µãƒ‹ã‚¿ã‚¤ã‚º"""
    if proto in ("https", "http"):
        return proto
    return "https"

def sanitize_host(host: str) -> str:
    """ãƒ›ã‚¹ãƒˆã‚µãƒ‹ã‚¿ã‚¤ã‚º"""
    # ãƒãƒ¼ãƒˆç•ªå·ã‚’å«ã‚€å¯èƒ½æ€§ã‚ã‚Š
    # è¨±å¯æ–‡å­—: è‹±æ•°å­—ã€ãƒã‚¤ãƒ•ãƒ³ã€ãƒ‰ãƒƒãƒˆã€ã‚³ãƒ­ãƒ³
    import re
    if re.match(r"^[a-zA-Z0-9\-\.:]+$", host):
        return host
    return "localhost"
```

---

### ãƒ†ã‚¹ãƒˆè¿½åŠ 

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `tests/test_csp_headers.py`ï¼ˆæ–°è¦ä½œæˆï¼‰

**ãƒ†ã‚¹ãƒˆå†…å®¹**ï¼ˆ27æœ¬ï¼‰:
1. CSP_MODE=off ã§ãƒ˜ãƒƒãƒ€ãªã—
2. CSP_MODE=report ã§ Report-Only ãƒ˜ãƒƒãƒ€
3. CSP_MODE=enforce ã§ CSP ãƒ˜ãƒƒãƒ€
4. report mode ã§ Reporting-Endpoints ãƒ˜ãƒƒãƒ€
5. enforce mode ã§ Reporting-Endpoints ãªã—ï¼ˆä»»æ„åˆºã—Bï¼‰
6. ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°æ©Ÿèƒ½ï¼ˆ60ç§’ã«1å›ï¼‰
7. DoSè€æ€§ï¼ˆã‚µã‚¤ã‚ºä¸Šé™ã€Content-Typeï¼‰
8. ä¾‹å¤–çµŒè·¯ã§ã®CSPãƒ˜ãƒƒãƒ€ä»˜ä¸

**å®Ÿè£…ä¾‹**:
```python
# tests/test_csp_headers.py

def test_csp_mode_off_no_header(client):
    """CSP_MODE=off ã§ã¯ãƒ˜ãƒƒãƒ€ãªã—"""
    # ç’°å¢ƒå¤‰æ•°è¨­å®š
    os.environ["CSP_MODE"] = "off"
    
    response = client.get("/")
    
    assert "Content-Security-Policy" not in response.headers
    assert "Content-Security-Policy-Report-Only" not in response.headers

def test_csp_mode_report_has_report_only_header(client):
    """CSP_MODE=report ã§ã¯ Report-Only ãƒ˜ãƒƒãƒ€"""
    os.environ["CSP_MODE"] = "report"
    
    response = client.get("/")
    
    assert "Content-Security-Policy-Report-Only" in response.headers
    assert "style-src 'self'" in response.headers["Content-Security-Policy-Report-Only"]

def test_csp_mode_enforce_has_csp_header(client):
    """CSP_MODE=enforce ã§ã¯ CSP ãƒ˜ãƒƒãƒ€"""
    os.environ["CSP_MODE"] = "enforce"
    
    response = client.get("/")
    
    assert "Content-Security-Policy" in response.headers
    assert "style-src 'self'" in response.headers["Content-Security-Policy"]

# ... æ®‹ã‚Š24æœ¬
```

---

### ä»»æ„åˆºã—A: app.state å„ªå…ˆå‚ç…§

**ç›®çš„**: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„

**å®Ÿè£…ç®‡æ‰€**:
- Line 1199-1205ï¼ˆlifespanï¼‰: app.state ã¸ã®åˆæœŸè¨­å®š
- Line 1249-1254ï¼ˆmiddlewareï¼‰: app.state ã‹ã‚‰ã®å–å¾—

**åŠ¹æœ**:
- æ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ `get_settings()` ã‚’å‘¼ã°ãªã„
- æ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ `_build_csp_policy()` ã‚’å‘¼ã°ãªã„

**Before**:
```python
def _apply_security_headers_to_response(response, request):
    settings = get_settings()  # æ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    csp_policy = _build_csp_policy(settings)  # æ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
```

**After**:
```python
# lifespanï¼ˆèµ·å‹•æ™‚1å›ã®ã¿ï¼‰
app.state.csp_policy = _build_csp_policy(settings)

# middlewareï¼ˆæ¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
csp_policy = request.app.state.csp_policy  # å–å¾—ã®ã¿
```

---

### ä»»æ„åˆºã—B: enforceå¾Œãƒ¬ãƒãƒ¼ãƒˆæ–¹é‡æ˜æ–‡åŒ–

**ç›®çš„**: é‹ç”¨ã‚³ã‚¹ãƒˆæŠ‘åˆ¶

**å®Ÿè£…ç®‡æ‰€**:
- Line 1139-1174ï¼ˆ_build_csp_policyï¼‰: report mode ã®æ¡ä»¶è¿½åŠ 
- Line 1270ï¼ˆmiddlewareï¼‰: report mode ã®æ¡ä»¶è¿½åŠ 

**æ–¹é‡**:
```
report mode:  report-uri âœ… / Reporting-Endpoints âœ…ï¼ˆè¦³æ¸¬ã®ãŸã‚ï¼‰
enforce mode: report-uri âŒ / Reporting-Endpoints âŒï¼ˆé‹ç”¨ã‚³ã‚¹ãƒˆæŠ‘åˆ¶ï¼‰

ç†ç”±: enforceå¾Œã¯é•åã‚’æ­¢ã‚ã‚‹ã ã‘ã§ã€ãƒ¬ãƒãƒ¼ãƒˆåé›†ã¯ä¸è¦
æ€æƒ³: ã€Œå‰²ã«åˆã‚ãªã„æ”»æ’ƒã¯ç„¡è¦–ã€
```

**Before**:
```python
if settings.csp_report_uri:
    directives.append(f"report-uri {settings.csp_report_uri}")
```

**After**:
```python
# report mode ã®ã¿
if settings.csp_report_uri and settings.csp_mode == "report":
    directives.append(f"report-uri {settings.csp_report_uri}")
```

---

### å¢ƒç•Œãƒãƒ¼ã‚«ãƒ¼è¨­ç½®

**ç›®çš„**: P0/P1 COREé ˜åŸŸã®ä¿è­·

**å®Ÿè£…ç®‡æ‰€**: app.py

```python
# === P0/P1 CORE: DO NOT EDIT IN P2.5 ===
# ï¼ˆP0/P1é ˜åŸŸï¼‰
# === P2.5 ONLY BELOW ===
# ï¼ˆP2.5é ˜åŸŸï¼‰
def _build_csp_policy(settings) -> str:
    ...
# === P2.5 END ===
```

**ä¿è¨¼**:
- å¢ƒç•Œãƒãƒ¼ã‚«ãƒ¼ã§è¦–è¦šçš„ã«ä¿è­·
- CIãƒã‚§ãƒƒã‚¯ã§æ¤œçŸ¥ï¼ˆå°†æ¥ï¼‰

---

### CI/CDçµ±åˆ

**ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**: `scripts/ci_smoke.ps1`ï¼ˆæ—¢å­˜ã«çµ±åˆï¼‰

**å®Ÿè¡Œä¾‹**:
```powershell
(.venv) PS> powershell -ExecutionPolicy Bypass -File .\scripts\ci_smoke.ps1
[ci_smoke] start
[ci_smoke] python=...\python.exe
Python 3.13.3
...................................................  [100%]
51 passed in 2.58s
[ci_smoke] pytest exit=0
[ci_smoke] prod gate check DB_PATH=...
prod gate ok
[ci_smoke] gate exit=0
[ci_smoke] PASS
```

---

### Phase 1å®Œäº†ç¢ºèªé …ç›®

- [ ] app.py ã¸ã®å®Ÿè£…å®Œäº†ï¼ˆç´„484è¡Œï¼‰
- [ ] ä»»æ„åˆºã—Aå®Œäº†ï¼ˆapp.stateå„ªå…ˆå‚ç…§ï¼‰
- [ ] ä»»æ„åˆºã—Bå®Œäº†ï¼ˆenforceå¾Œãƒ¬ãƒãƒ¼ãƒˆæ–¹é‡ï¼‰
- [ ] ãƒ†ã‚¹ãƒˆ51æœ¬å…¨green
- [ ] CI/CDçµ±åˆå®Œäº†
- [ ] å¢ƒç•Œãƒãƒ¼ã‚«ãƒ¼è¨­ç½®ï¼ˆP0/P1 COREä¿è­·ï¼‰

---

## P2.5 Phase 2: UIæ”¹ä¿®

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: â­ï¸ å¾…æ©Ÿä¸­ï¼ˆP3ç§»è¡Œå‰ã«å®Ÿæ–½ï¼‰

### å‰ææ¡ä»¶

**ç¾çŠ¶ã®å•é¡Œ**:
- static/index.htmx ã« inline style ãŒæ®‹å­˜ï¼ˆLine 12-441ï¼‰
- CSP enforce æ™‚ã« UI ãŒç ´æã™ã‚‹

**å¯¾ç­–**:
- inline style ã‚’å¤–éƒ¨CSSåŒ–
- `<style>` ã‚¿ã‚°ã‚’ `<link rel="stylesheet">` ã«å¤‰æ›´

---

### å®Ÿè£…æ‰‹é †

#### Step 1: static/styles.css ä½œæˆ

**ä½œæ¥­å†…å®¹**:
```bash
# index.htmx ã® Line 12-441 ã‚’ã‚³ãƒ”ãƒ¼
# <style> ã¨ </style> ã‚’é™¤å¤–
# static/styles.css ã«ä¿å­˜
```

**æ³¨æ„äº‹é …**:
- CSS ã®å†…å®¹ã¯å¤‰æ›´ã—ãªã„ï¼ˆãã®ã¾ã¾ç§»å‹•ï¼‰
- ã‚»ãƒ¬ã‚¯ã‚¿ã‚„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ç¶­æŒ

---

#### Step 2: index.htmx ä¿®æ­£

**Before**ï¼ˆLine 10-13ï¼‰:
```html
<script src="/static/vendor/htmx.min.js"></script>
<script src="/static/ui.js" defer></script>
<style>
  * {
    margin: 0;
    /* ... ç´„430è¡Œ ... */
  }
</style>
```

**After**:
```html
<script src="/static/vendor/htmx.min.js"></script>
<script src="/static/ui.js" defer></script>
<link rel="stylesheet" href="/static/styles.css">
```

---

#### Step 3: test_csp_static_compat.py è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: `tests/test_csp_static_compat.py`

**ãƒ†ã‚¹ãƒˆå†…å®¹**:
1. `test_static_html_has_no_inline_style_or_script()`: inline style/script æ¤œå‡º
2. `test_ui_js_has_no_eval_or_function_constructor()`: eval() / Function() æ¤œå‡º
3. `test_csp_policy_matches_static_content_contract()`: CSPãƒãƒªã‚·ãƒ¼æ•´åˆæ€§ç¢ºèª

**è¿½åŠ æ–¹æ³•**:
```bash
# ä¿ç®¡ä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
cp /path/to/test_csp_static_compat.py tests/
```

**ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ**:
```bash
# æ–°è¦ãƒ†ã‚¹ãƒˆã®ã¿
python -m pytest tests/test_csp_static_compat.py -v

# æœŸå¾…çµæœ
================================ test session starts =================================
tests\test_csp_static_compat.py::test_static_html_has_no_inline_style_or_script PASSED
tests\test_csp_static_compat.py::test_ui_js_has_no_eval_or_function_constructor PASSED
tests\test_csp_static_compat.py::test_csp_policy_matches_static_content_contract PASSED
================================= 3 passed in 0.12s ==================================

# å…¨ãƒ†ã‚¹ãƒˆ
python -m pytest -q

# æœŸå¾…çµæœ
......................................................  [100%]
54 passed in 2.87s
```

---

### å®Œäº†ç¢ºèªé …ç›®

- [ ] static/styles.css ä½œæˆå®Œäº†
- [ ] index.htmx ã‹ã‚‰ `<style>` ã‚¿ã‚°å‰Šé™¤
- [ ] `<link rel="stylesheet" href="/static/styles.css">` è¿½åŠ 
- [ ] test_csp_static_compat.py è¿½åŠ 
- [ ] ãƒ†ã‚¹ãƒˆ54æœ¬å…¨greenç¢ºèª
- [ ] UIè¡¨ç¤ºç¢ºèªï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰

**æ‰€è¦æ™‚é–“**: ç´„30åˆ†ã€œ1æ™‚é–“

---

## P2.5 Phase 3: enforceç§»è¡Œ

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: â­ï¸ ä¿ç•™ï¼ˆPhase 2å®Œäº†å¾Œã«å®Ÿæ–½ï¼‰

### å‰ææ¡ä»¶

**å¿…é ˆ**:
- Phase 2ï¼ˆUIæ”¹ä¿®ï¼‰å®Œäº†
- test_csp_static_compat.py ãŒå…¨green

---

### ç’°å¢ƒå¤‰æ•°è¨­å®š

**ç¾åœ¨ï¼ˆCSP_MODE=reportï¼‰**:
```bash
MODE=prod
CSP_MODE=report
CSP_USE_REPORTING_API=1
CSP_REPORT_URI=/__csp_report

SESSION_SECRET=<æœ¬ç•ªç”¨secret>
ADMIN_PASSWORD=<æœ¬ç•ªç”¨password>
DEV_PASSWORD=<æœ¬ç•ªç”¨password>
DB_PATH=<æœ¬ç•ªDB path>
```

---

### Phase 3.1: CSP_MODE=report é‹ç”¨

**æœŸé–“**: æœ€ä½1æ—¥ã€œæ•°æ—¥

#### å®Ÿæ–½å†…å®¹

**1. UIã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª**:
```bash
# ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:8000 ã«ã‚¢ã‚¯ã‚»ã‚¹
# å…¨æ©Ÿèƒ½ãŒæ­£å¸¸å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
```

**2. æ„å›³çš„é•åãƒ†ã‚¹ãƒˆ**:
```javascript
// DevTools Console ã§å®Ÿè¡Œ
eval("1")

// æœŸå¾…çµæœ: Console ã« CSP violation è¡¨ç¤º
// Network ã‚¿ãƒ–ã§ /__csp_report ã¸ã® POST 204 ç¢ºèª
```

**3. ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ç¢ºèª**:
```bash
# ãƒ­ã‚°ã§ violation ã‚’ç¢ºèª
grep "CSP violation" <log_file>

# æœŸå¾…çµæœï¼ˆä¾‹ï¼‰
INFO: CSP violation: blocked-uri=eval, violated-directive=script-src 'self'
```

**4. æ™®æ®µã®å°ç·šç¢ºèª**:
- [ ] scanå®Ÿè¡Œï¼ˆ`/scan?full=1`ï¼‰
- [ ] notesä¸€è¦§è¡¨ç¤º
- [ ] filtersæ“ä½œï¼ˆstatus, priorityï¼‰
- [ ] modalé–‹é–‰
- [ ] PATCHå®Ÿè¡Œï¼ˆstatus/priorityå¤‰æ›´ï¼‰
- [ ] commentè¿½åŠ 
- [ ] exportå®Ÿè¡Œ

**5. violation åæŸç¢ºèª**:
- ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã§æ„å›³ã—ãªã„ violation ãŒãªã„ã“ã¨
- ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã§60ç§’ã«1å›ã®ãƒ­ã‚°ãŒæ­£å¸¸å‹•ä½œ

**å®Œäº†æ¡ä»¶**:
- âœ… å…¨æ©Ÿèƒ½æ­£å¸¸å‹•ä½œ
- âœ… æ„å›³ã—ãªã„ violation ãªã—
- âœ… æœ€ä½1æ—¥ã€œæ•°æ—¥ã®å®‰å®šé‹ç”¨

---

### Phase 3.2: CSP_MODE=enforce ç§»è¡Œ

**ç’°å¢ƒå¤‰æ•°å¤‰æ›´**:
```bash
CSP_MODE=enforce  # å¤‰æ›´ã™ã‚‹ã®ã¯ã“ã‚Œã ã‘

# ãã®ä»–ã¯å¤‰æ›´ãªã—
# CSP_USE_REPORTING_API / CSP_REPORT_URI ã¯ãã®ã¾ã¾
# ï¼ˆenforce ã§ã¯ç„¡è¦–ã•ã‚Œã‚‹ - ä»»æ„åˆºã—Bï¼‰
```

**ã‚¢ãƒ—ãƒªå†èµ·å‹•**:
```bash
uvicorn app:app --host 0.0.0.0 --port 8000
```

**å®Œäº†ç¢ºèªé …ç›®**:
1. å…¨æ©Ÿèƒ½æ­£å¸¸å‹•ä½œ
2. DevTools ã«ã‚¨ãƒ©ãƒ¼ãªã—
3. UI/UX ã«å½±éŸ¿ãªã—
4. ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½OFFç¢ºèªï¼ˆ`/__csp_report` ã¸ã® POST ãŒãªã„ï¼‰

**æœ¬ç•ªé‹ç”¨æœŸé–“**: æœ€ä½1é€±é–“ã€œ1ãƒ¶æœˆ

---

### é€€è·¯ï¼ˆäº‹æ•…æ™‚ã®å¯¾å‡¦ï¼‰

**Step 1: å³åº§ã«CSPç„¡åŠ¹åŒ–**:
```bash
CSP_MODE=off
```

**Step 2: ã‚¢ãƒ—ãƒªå†èµ·å‹•**:
```bash
uvicorn app:app --host 0.0.0.0 --port 8000
```

**Step 3: åŸå› èª¿æŸ»**:
- DevTools Console ã§ã‚¨ãƒ©ãƒ¼ç¢ºèª
- ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã§ violation ç¢ºèª
- å•é¡Œã®ã‚ã‚‹ inline style/script ã‚’ç‰¹å®š

**Step 4: ä¿®æ­£**:
- inline style â†’ å¤–éƒ¨CSS
- inline script â†’ å¤–éƒ¨JS
- ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

**Step 5: å†åº¦ report ãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰**:
```bash
CSP_MODE=report
```

---

## P2.5å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase 1: å®Ÿè£…å®Œäº†ï¼ˆâœ… ã¾ãŸã¯ â­ï¸ï¼‰

- [ ] app.py ã¸ã®å®Ÿè£…å®Œäº†ï¼ˆç´„484è¡Œï¼‰
- [ ] ä»»æ„åˆºã—Aå®Œäº†ï¼ˆapp.stateå„ªå…ˆå‚ç…§ï¼‰
- [ ] ä»»æ„åˆºã—Bå®Œäº†ï¼ˆenforceå¾Œãƒ¬ãƒãƒ¼ãƒˆæ–¹é‡ï¼‰
- [ ] ãƒ†ã‚¹ãƒˆ51æœ¬å…¨green
- [ ] CI/CDçµ±åˆå®Œäº†
- [ ] å¢ƒç•Œãƒãƒ¼ã‚«ãƒ¼è¨­ç½®

---

### Phase 2: UIæ”¹ä¿®ï¼ˆâ­ï¸ å°†æ¥å®Ÿæ–½ï¼‰

- [ ] static/styles.css ä½œæˆ
- [ ] index.htmx ä¿®æ­£ï¼ˆ`<style>` â†’ `<link>`ï¼‰
- [ ] test_csp_static_compat.py è¿½åŠ 
- [ ] ãƒ†ã‚¹ãƒˆ54æœ¬å…¨greenç¢ºèª
- [ ] UIè¡¨ç¤ºç¢ºèª

**æ‰€è¦æ™‚é–“**: ç´„30åˆ†ã€œ1æ™‚é–“

---

### Phase 3: CSP enforce ç§»è¡Œï¼ˆâ­ï¸ Phase 2å¾Œï¼‰

#### Phase 3.1: report é‹ç”¨
- [ ] CSP_MODE=report è¨­å®š
- [ ] å…¨æ©Ÿèƒ½å‹•ä½œç¢ºèª
- [ ] violation åæŸç¢ºèª
- [ ] 1æ—¥ã€œæ•°æ—¥ã®å®‰å®šé‹ç”¨

#### Phase 3.2: enforce ç§»è¡Œ
- [ ] CSP_MODE=enforce è¨­å®š
- [ ] å…¨æ©Ÿèƒ½å‹•ä½œç¢ºèª
- [ ] DevTools ã‚¨ãƒ©ãƒ¼ãªã—ç¢ºèª
- [ ] ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½OFFç¢ºèª
- [ ] 1é€±é–“ã€œ1ãƒ¶æœˆã®æœ¬ç•ªé‹ç”¨

**æ‰€è¦æ™‚é–“**: 1é€±é–“ã€œ1ãƒ¶æœˆï¼ˆé‹ç”¨æœŸé–“å«ã‚€ï¼‰

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆå…¨ä½“ï¼‰

### P2.0é–¢é€£

**å•é¡Œ1: inline ãŒæ®‹ã£ã¦ã„ã‚‹**:
```bash
# ç¢ºèª
python - <<'PY'
import re, pathlib
s = pathlib.Path("static/index.htmx").read_text(encoding="utf-8")
m = re.findall(r'<script(?![^>]*\bsrc=)|onclick=|hx-on:', s, flags=re.I)
print(f"æ®‹å­˜: {len(m)}")
PY

# å¯¾å‡¦: Step A-1, A-2ã‚’å†ç¢ºèª
```

**å•é¡Œ2: å¾ªç’°import ã‚¨ãƒ©ãƒ¼**:
```python
# ã‚¨ãƒ©ãƒ¼ä¾‹
ImportError: cannot import name 'get_settings' from partially initialized module 'app'

# åŸå› : render.py ãŒ app ã‚’ import ã—ã¦ã„ã‚‹
# å¯¾å‡¦: å¼•æ•°ã§å¿…è¦ãªæƒ…å ±ã‚’æ¸¡ã™
```

---

### P2.5é–¢é€£

**å•é¡Œ3: ãƒ†ã‚¹ãƒˆãŒè½ã¡ã‚‹**:
```bash
# ç¢ºèª
python -m pytest -v

# å¯¾å‡¦: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª
# - ç’°å¢ƒå¤‰æ•°è¨­å®š
# - DBçŠ¶æ…‹
```

**å•é¡Œ4: inline style ãŒæ¤œå‡ºã•ã‚Œã‚‹ï¼ˆPhase 2ï¼‰**:
```bash
# ç¢ºèª
python -m pytest tests/test_csp_static_compat.py -v

# å¯¾å‡¦: Phase 2ã®æ‰‹é †ã‚’å†ç¢ºèª
```

**å•é¡Œ5: enforce ã§ UI ãŒå£Šã‚Œã‚‹ï¼ˆPhase 3.2ï¼‰**:
```bash
# ç·Šæ€¥å¯¾å‡¦
CSP_MODE=off

# å†èµ·å‹•
uvicorn app:app --reload

# åŸå› èª¿æŸ»
# DevTools Console ã§ã‚¨ãƒ©ãƒ¼ç¢ºèª
```

---

## å®Œäº†å ±å‘Šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

### P2.0å®Œäº†æ™‚

```
P2.0 å®Ÿè£…å®Œäº†ã—ã¾ã—ãŸã€‚

ã€æ©Ÿæ¢°ãƒã‚§ãƒƒã‚¯çµæœã€‘
- app.py ã® render_ é–¢æ•°: 0ä»¶ âœ…
- render.py ã® import app: 0ä»¶ âœ…
- index.htmx ã® inline script: 0ä»¶ âœ…
- ãƒ†ã‚¹ãƒˆ: å…¨ã¦ pass âœ…

ã€æ‰‹å‹•ç¢ºèªçµæœã€‘
- UIè¡¨ç¤º: OK âœ…
- scanå®Ÿè¡Œ: OK âœ…
- resultè‡ªå‹•æ¶ˆå»: OK âœ…
- Clear filters: OK âœ…
- Modal: OK âœ…
- Console ã‚¨ãƒ©ãƒ¼: ãªã— âœ…

ä»¥ä¸Šã€P2.0 å®Œäº†ã§ã™ã€‚
```

---

### P2.5 Phase 1å®Œäº†æ™‚

```
P2.5 Phase 1 å®Ÿè£…å®Œäº†ã—ã¾ã—ãŸã€‚

ã€å®Ÿè£…å†…å®¹ã€‘
- app.py ã¸ã®è¿½åŠ : ç´„484è¡Œ âœ…
- ä»»æ„åˆºã—A: app.stateå„ªå…ˆå‚ç…§ âœ…
- ä»»æ„åˆºã—B: enforceå¾Œãƒ¬ãƒãƒ¼ãƒˆæ–¹é‡ âœ…
- ãƒ†ã‚¹ãƒˆè¿½åŠ : test_csp_headers.py (27æœ¬) âœ…
- CIçµ±åˆ: scripts/ci_smoke.ps1 âœ…

ã€ãƒ†ã‚¹ãƒˆçµæœã€‘
- 51æœ¬å…¨green âœ…
- CI: PASS âœ…

ã€å¢ƒç•Œãƒãƒ¼ã‚«ãƒ¼ã€‘
- P0/P1 COREé ˜åŸŸä¿è­· âœ…

ä»¥ä¸Šã€P2.5 Phase 1 å®Œäº†ã§ã™ã€‚
æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: Phase 2ï¼ˆUIæ”¹ä¿®ï¼‰
```

---

**10_P2å®Ÿè£…æ‰‹é †æ›¸_å®Œå…¨ç‰ˆ.md - çµ‚ã‚ã‚Š**
